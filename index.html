<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XA ‚Äî Command Centre | Upside</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
:root{--bg0:#04060a;--bg1:#090c14;--bg2:#0e1220;--bg3:#161c2e;--bg4:#1e2640;--fg:#e4e8f4;--fg2:#b4bcd4;--fg3:#7580a0;--fg4:#4a5270;--border:rgba(120,140,200,.08);--border2:rgba(120,140,200,.16);--g:#00e676;--g2:#69f0ae;--r:#ff3d71;--y:#ffc107;--b:#40c4ff;--p:#b388ff;--mono:'JetBrains Mono','Fira Code','Consolas',monospace;--sans:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,sans-serif;--serif:'Instrument Serif',Georgia,serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body,#root{height:100%}
body{background:var(--bg0);color:var(--fg);font-family:var(--sans);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
input,textarea,select{font-family:inherit}input:focus,textarea:focus,select:focus{outline:none;border-color:var(--g)!important}button{font-family:inherit}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes glow{0%,100%{box-shadow:0 0 8px var(--g)}50%{box-shadow:0 0 20px var(--g)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useMemo,useCallback,useEffect,useRef}=React;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LS={get(k){try{return JSON.parse(localStorage.getItem(k))}catch{return null}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
function download(content,filename,mime='text/csv'){const b=new Blob([content],{type:mime});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=filename;a.click();URL.revokeObjectURL(u)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCENARIO ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SCENARIOS=[
  {id:"db",label:"Deep Bear",color:"#ef4444",bp:5},
  {id:"b",label:"Bear",color:"#f97316",bp:10},
  {id:"mb",label:"Mild Bear",color:"#eab308",bp:15},
  {id:"base",label:"Base",color:"#6366f1",bp:35},
  {id:"mbu",label:"Mild Bull",color:"#22d3ee",bp:20},
  {id:"bu",label:"Bull",color:"#10b981",bp:10},
  {id:"dbu",label:"Deep Bull",color:"#06d6a0",bp:5},
];

function runEngine(stock,driverMap,globalDrivers){
  if(!stock.prices||stock.prices.length!==7)return null;
  const mapped=driverMap.filter(m=>m.active!==false);
  const tw=mapped.reduce((s,m)=>s+m.weight,0)||1;
  const bp=SCENARIOS.map(s=>s.bp);
  const sp=bp.map((b,si)=>{
    const dir=si-3;let ms=0;
    mapped.forEach(m=>{
      const gd=globalDrivers.find(g=>g.id===m.driverId);
      const sig=gd?gd.signal:0;
      const sens=stock.sens?.[m.driverId]||0;
      ms+=(m.weight/tw)*sig*sens*dir*0.15;
    });
    return Math.max(1,b*(1+ms));
  });
  const tot=sp.reduce((s,p)=>s+p,0);
  const pr=sp.map(p=>(p/tot)*100);
  const ev=pr.reduce((s,p,i)=>s+(p/100)*stock.prices[i],0);
  const c=stock.currentPrice||stock.prices[3];
  const rr=c>0?((ev-c)/c)*100:0;
  const buw=pr.slice(4).reduce((s,p,i)=>s+p*Math.abs(stock.prices[i+4]-ev),0);
  const bew=pr.slice(0,3).reduce((s,p,i)=>s+p*Math.abs(stock.prices[i]-ev),0);
  const skew=bew>0?buw/bew:2;
  let vd="NEUTRAL";
  if(rr>15&&skew>1.2)vd="STRONG LONG";
  else if(rr>8&&skew>0.8)vd="LONG";
  else if(rr<-15&&skew<0.6)vd="STRONG SHORT";
  else if(rr<-8&&skew<0.8)vd="SHORT";
  let tier="Watchlist";
  if(Math.abs(rr)>15)tier="Core";
  else if(Math.abs(rr)>8)tier="Satellite";
  return{pr,ev,rr,skew,vd,tier};
}

const fmt=(v,t)=>{if(v===null||v===undefined||isNaN(v))return'‚Äî';if(t==='pct')return`${v>=0?'+':''}${v.toFixed(1)}%`;if(t==='ratio')return`${v.toFixed(1)}x`;return`${v.toFixed(1)}`};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPERATOR REGISTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const OPERATORS = [
  {
    id:"tig", name:"Tig", fullName:"Kris 'Tig' Paronto", teamId:"travel",
    team:"Travel", color:"#00e676", icon:"‚úà", file:"tig-v2.html",
    desc:"K-Shape Travel Divergence",
    driverMap:[
      {driverId:"kshape",weight:25},{driverId:"rates_tig",weight:20},{driverId:"oil_tig",weight:20},
      {driverId:"consumer_tig",weight:15},{driverId:"btravel",weight:10},{driverId:"premium",weight:10},
    ],
    drivers:[
      {id:"kshape",label:"K-Shape Divergence",signal:0.7},
      {id:"rates_tig",label:"Interest Rates",signal:-0.3},
      {id:"oil_tig",label:"Oil Price Trajectory",signal:0.2},
      {id:"consumer_tig",label:"Consumer Confidence",signal:0.4},
      {id:"btravel",label:"Business Travel Shift",signal:0.5},
      {id:"premium",label:"Premiumisation",signal:0.6},
    ],
    stocks:[
      {ticker:"NAS.OL",name:"Norwegian Air",verdict:"long",currentPrice:12.8,prices:[6.5,8.2,10.5,14.8,17.5,21,26],sens:{kshape:.8,rates_tig:-.6,oil_tig:-.5,consumer_tig:.7,btravel:.3,premium:.9}},
      {ticker:"IAG.L",name:"IAG (BA/Iberia)",verdict:"long",currentPrice:2.15,prices:[1.1,1.45,1.8,2.5,2.95,3.5,4.2],sens:{kshape:.7,rates_tig:-.4,oil_tig:-.6,consumer_tig:.6,btravel:.7,premium:.8}},
      {ticker:"EZJ.L",name:"easyJet",verdict:"long",currentPrice:5.4,prices:[2.8,3.6,4.5,6.2,7.4,8.8,11],sens:{kshape:.6,rates_tig:-.5,oil_tig:-.7,consumer_tig:.5,btravel:.2,premium:.7}},
      {ticker:"THYAO.IS",name:"Turkish Airlines",verdict:"long",currentPrice:282,prices:[140,185,230,320,380,450,560],sens:{kshape:.5,rates_tig:-.3,oil_tig:-.4,consumer_tig:.4,btravel:.8,premium:.7}},
      {ticker:"QAN.AX",name:"Qantas",verdict:"long",currentPrice:8.9,prices:[4.5,5.8,7.2,10.2,12,14.5,18],sens:{kshape:.6,rates_tig:-.3,oil_tig:-.5,consumer_tig:.5,btravel:.6,premium:.8}},
      {ticker:"MAR",name:"Marriott",verdict:"long",currentPrice:265,prices:[160,195,230,290,330,380,440],sens:{kshape:.7,rates_tig:-.2,oil_tig:-.1,consumer_tig:.8,btravel:.6,premium:.9}},
      {ticker:"IHG.L",name:"IHG",verdict:"long",currentPrice:88.5,prices:[52,64,76,98,112,130,155],sens:{kshape:.7,rates_tig:-.2,oil_tig:-.1,consumer_tig:.7,btravel:.5,premium:.8}},
      {ticker:"BKNG",name:"Booking Holdings",verdict:"long",currentPrice:4450,prices:[2800,3400,3900,4800,5400,6200,7500],sens:{kshape:.5,rates_tig:-.2,oil_tig:-.1,consumer_tig:.6,btravel:.4,premium:.7}},
      {ticker:"ZURN.SW",name:"Zurich Airport",verdict:"long",currentPrice:205,prices:[130,155,180,225,260,300,360],sens:{kshape:.4,rates_tig:-.2,oil_tig:-.1,consumer_tig:.5,btravel:.3,premium:.6}},
      {ticker:"WIZZ.L",name:"Wizz Air",verdict:"short",currentPrice:18.5,prices:[6,9.5,13,17,22,28,35],sens:{kshape:-.8,rates_tig:.5,oil_tig:.7,consumer_tig:-.6,btravel:-.2,premium:-.9}},
      {ticker:"RYA.L",name:"Ryanair",verdict:"short",currentPrice:18.8,prices:[8.5,12,15.5,19.5,23,27,32],sens:{kshape:-.6,rates_tig:.4,oil_tig:.6,consumer_tig:-.4,btravel:-.1,premium:-.7}},
      {ticker:"AF.PA",name:"Air France-KLM",verdict:"short",currentPrice:8.2,prices:[2.5,4,5.8,7.8,10.5,13,16],sens:{kshape:-.7,rates_tig:.6,oil_tig:.5,consumer_tig:-.5,btravel:-.3,premium:-.6}},
      {ticker:"LHA.DE",name:"Lufthansa",verdict:"short",currentPrice:6.5,prices:[2,3.2,4.6,6.2,8,10,13],sens:{kshape:-.6,rates_tig:.5,oil_tig:.4,consumer_tig:-.4,btravel:-.4,premium:-.5}},
      {ticker:"WH",name:"Wyndham",verdict:"short",currentPrice:82,prices:[45,55,68,80,95,110,130],sens:{kshape:-.6,rates_tig:.3,oil_tig:.2,consumer_tig:-.7,btravel:-.3,premium:-.8}},
      {ticker:"FRA.DE",name:"Fraport",verdict:"short",currentPrice:52,prices:[28,36,44,54,62,72,85],sens:{kshape:-.4,rates_tig:.4,oil_tig:.2,consumer_tig:-.3,btravel:-.2,premium:-.5}},
    ]
  },
  {
    id:"rone", name:"Rone", fullName:"Mark 'Oz' Geist", teamId:"defence",
    team:"Defence", color:"#40c4ff", icon:"üõ°", file:"rone-v2.html",
    desc:"NATO Rearmament Supercycle",
    driverMap:[
      {driverId:"nato",weight:30},{driverId:"geopol",weight:25},{driverId:"autonomy",weight:15},
      {driverId:"rates_rone",weight:10},{driverId:"supply",weight:10},{driverId:"oil_rone",weight:10},
    ],
    drivers:[
      {id:"nato",label:"NATO / Defence Spend",signal:0.8},
      {id:"geopol",label:"Geopolitical Escalation",signal:0.5},
      {id:"autonomy",label:"EU Strategic Autonomy",signal:0.6},
      {id:"rates_rone",label:"Interest Rates",signal:-0.3},
      {id:"supply",label:"Supply Chain Capacity",signal:0.3},
      {id:"oil_rone",label:"Oil Price",signal:0.2},
    ],
    stocks:[
      {ticker:"BA.L",name:"BAE Systems",verdict:"long",currentPrice:2031,prices:[1400,1650,1850,2200,2450,2750,3200],sens:{nato:.8,geopol:.7,autonomy:.5,rates_rone:-.3,supply:-.2,oil_rone:-.1}},
      {ticker:"RHM.DE",name:"Rheinmetall",verdict:"long",currentPrice:1609,prices:[900,1100,1350,1750,2050,2400,3000],sens:{nato:.9,geopol:.9,autonomy:.7,rates_rone:-.4,supply:-.6,oil_rone:-.1}},
      {ticker:"SAAB-B.ST",name:"Saab",verdict:"long",currentPrice:657,prices:[380,470,560,720,840,980,1200],sens:{nato:.8,geopol:.8,autonomy:.6,rates_rone:-.2,supply:-.3,oil_rone:-.1}},
      {ticker:"HO.PA",name:"Thales",verdict:"long",currentPrice:245,prices:[165,195,220,270,310,360,430],sens:{nato:.7,geopol:.6,autonomy:.7,rates_rone:-.2,supply:-.2,oil_rone:-.1}},
      {ticker:"LDO.MI",name:"Leonardo",verdict:"long",currentPrice:54,prices:[30,38,46,60,70,82,100],sens:{nato:.7,geopol:.6,autonomy:.6,rates_rone:-.5,supply:-.3,oil_rone:-.1}},
      {ticker:"AIR.PA",name:"Airbus D&S",verdict:"long",currentPrice:192,prices:[130,155,175,210,240,275,330],sens:{nato:.7,geopol:.5,autonomy:.8,rates_rone:-.3,supply:-.4,oil_rone:-.1}},
      {ticker:"RR.L",name:"Rolls-Royce",verdict:"long",currentPrice:1271,prices:[800,950,1100,1400,1600,1850,2200],sens:{nato:.5,geopol:.4,autonomy:.4,rates_rone:-.3,supply:-.3,oil_rone:-.1}},
      {ticker:"QQ.L",name:"QinetiQ",verdict:"long",currentPrice:474,prices:[320,380,430,520,580,660,780],sens:{nato:.6,geopol:.4,autonomy:.3,rates_rone:-.2,supply:-.1,oil_rone:0}},
      {ticker:"LMT",name:"Lockheed Martin",verdict:"short",currentPrice:653,prices:[420,500,570,640,720,810,950],sens:{nato:.3,geopol:.4,autonomy:-.7,rates_rone:-.2,supply:-.1,oil_rone:0}},
      {ticker:"GD",name:"General Dynamics",verdict:"short",currentPrice:360,prices:[240,280,320,365,410,460,530],sens:{nato:.2,geopol:.3,autonomy:-.6,rates_rone:-.3,supply:-.1,oil_rone:0}},
      {ticker:"HAG.DE",name:"Hensoldt",verdict:"short",currentPrice:81,prices:[40,52,65,78,95,115,145],sens:{nato:.5,geopol:.4,autonomy:.3,rates_rone:-.5,supply:-.6,oil_rone:0}},
      {ticker:"AVON.L",name:"Avon Protection",verdict:"short",currentPrice:1050,prices:[600,750,900,1050,1200,1400,1700],sens:{nato:.3,geopol:.3,autonomy:.1,rates_rone:-.3,supply:-.4,oil_rone:0}},
      {ticker:"CHG.L",name:"Chemring",verdict:"short",currentPrice:500,prices:[320,380,440,510,580,660,780],sens:{nato:.4,geopol:.3,autonomy:.2,rates_rone:-.3,supply:-.5,oil_rone:0}},
    ]
  },
  {
    id:"tanto", name:"Tanto", fullName:"Kris 'Tanto' Paronto", teamId:"energy",
    team:"Energy & Commodities", color:"#f59e0b", icon:"üõ¢", file:"tanto-v2.html",
    desc:"Energy Transition Divergence",
    driverMap:[
      {driverId:"t_oilprice",weight:30},{driverId:"t_opec",weight:20},{driverId:"t_transition",weight:15},
      {driverId:"t_rates",weight:10},{driverId:"t_china",weight:15},{driverId:"t_capex",weight:10},
    ],
    drivers:[
      {id:"t_oilprice",label:"Oil Price Trajectory",signal:-0.2},
      {id:"t_opec",label:"OPEC+ Discipline",signal:0.3},
      {id:"t_transition",label:"Energy Transition",signal:0.4},
      {id:"t_rates",label:"Interest Rates",signal:-0.3},
      {id:"t_china",label:"China Demand",signal:-0.2},
      {id:"t_capex",label:"Capex Discipline",signal:0.5},
    ],
    stocks:[
      {ticker:"SHEL",name:"Shell",verdict:"long",currentPrice:78,prices:[48,58,68,85,98,115,140],sens:{t_oilprice:.7,t_opec:.6,t_transition:-.3,t_rates:-.2,t_china:.5,t_capex:.7}},
      {ticker:"XOM",name:"ExxonMobil",verdict:"long",currentPrice:149,prices:[95,115,132,160,182,210,250],sens:{t_oilprice:.8,t_opec:.5,t_transition:-.4,t_rates:-.1,t_china:.4,t_capex:.8}},
      {ticker:"CVX",name:"Chevron",verdict:"long",currentPrice:184,prices:[115,140,162,195,225,260,310],sens:{t_oilprice:.7,t_opec:.5,t_transition:-.3,t_rates:-.2,t_china:.4,t_capex:.9}},
      {ticker:"TTE",name:"TotalEnergies",verdict:"long",currentPrice:77,prices:[45,55,66,82,96,115,140],sens:{t_oilprice:.6,t_opec:.5,t_transition:.2,t_rates:-.2,t_china:.5,t_capex:.6}},
      {ticker:"EQNR",name:"Equinor",verdict:"long",currentPrice:28,prices:[16,20,24,30,36,43,52],sens:{t_oilprice:.8,t_opec:.6,t_transition:.3,t_rates:-.1,t_china:.3,t_capex:.5}},
      {ticker:"CNQ",name:"Canadian Natural",verdict:"long",currentPrice:28,prices:[15,19,23,30,36,44,55],sens:{t_oilprice:.9,t_opec:.4,t_transition:-.5,t_rates:-.3,t_china:.3,t_capex:.8}},
      {ticker:"SU",name:"Suncor Energy",verdict:"long",currentPrice:55,prices:[32,39,47,59,70,84,105],sens:{t_oilprice:.8,t_opec:.4,t_transition:-.4,t_rates:-.2,t_china:.3,t_capex:.7}},
      {ticker:"VET",name:"Vermilion Energy",verdict:"long",currentPrice:9.5,prices:[4,5.5,7.5,11,14,18,24],sens:{t_oilprice:.9,t_opec:.5,t_transition:-.6,t_rates:-.4,t_china:.4,t_capex:.6}},
      {ticker:"BP",name:"BP",verdict:"short",currentPrice:39,prices:[18,24,31,38,48,58,72],sens:{t_oilprice:-.5,t_opec:-.4,t_transition:.3,t_rates:.3,t_china:-.3,t_capex:-.7}},
      {ticker:"OXY",name:"Occidental",verdict:"short",currentPrice:46,prices:[22,30,38,48,56,66,80],sens:{t_oilprice:-.6,t_opec:-.3,t_transition:-.2,t_rates:.2,t_china:-.2,t_capex:-.8}},
      {ticker:"RIG",name:"Transocean",verdict:"short",currentPrice:3.8,prices:[1,1.8,2.8,4,5.5,7.5,10],sens:{t_oilprice:-.8,t_opec:-.5,t_transition:-.6,t_rates:.5,t_china:-.4,t_capex:-.5}},
      {ticker:"HAL",name:"Halliburton",verdict:"short",currentPrice:24,prices:[12,16,20,25,30,36,44],sens:{t_oilprice:-.6,t_opec:-.4,t_transition:-.3,t_rates:.2,t_china:-.3,t_capex:-.4}},
      {ticker:"PBR",name:"Petrobras",verdict:"short",currentPrice:15,prices:[7,9.5,12.5,15.5,19,23,28],sens:{t_oilprice:-.5,t_opec:-.3,t_transition:-.1,t_rates:.4,t_china:-.5,t_capex:-.3}},
    ]
  },
  {
    id:"jack", name:"Jack", fullName:"Jack Silva", teamId:"semiconductors",
    team:"AI & Semiconductors", color:"#818cf8", icon:"üß†", file:"jack-v2.html",
    desc:"AI Capex Supercycle",
    driverMap:[
      {driverId:"j_aicapex",weight:30},{driverId:"j_china",weight:20},{driverId:"j_rates",weight:15},
      {driverId:"j_consumer",weight:10},{driverId:"j_foundry",weight:15},{driverId:"j_regulation",weight:10},
    ],
    drivers:[
      {id:"j_aicapex",label:"AI Capex Momentum",signal:0.7},
      {id:"j_china",label:"China/Export Controls",signal:-0.3},
      {id:"j_rates",label:"Rates & Multiples",signal:-0.2},
      {id:"j_consumer",label:"Consumer Demand",signal:0.3},
      {id:"j_foundry",label:"Foundry/Supply Chain",signal:0.4},
      {id:"j_regulation",label:"AI Regulation Risk",signal:-0.1},
    ],
    stocks:[
      {ticker:"NVDA",name:"NVIDIA",verdict:"long",currentPrice:183,prices:[95,125,155,200,240,290,360],sens:{j_aicapex:.9,j_china:-.4,j_rates:-.3,j_consumer:.3,j_foundry:.6,j_regulation:-.4}},
      {ticker:"TSM",name:"TSMC",verdict:"long",currentPrice:366,prices:[200,260,320,400,475,560,680],sens:{j_aicapex:.7,j_china:-.6,j_rates:-.2,j_consumer:.4,j_foundry:.9,j_regulation:-.2}},
      {ticker:"AVGO",name:"Broadcom",verdict:"long",currentPrice:325,prices:[180,235,285,355,420,500,620],sens:{j_aicapex:.8,j_china:-.3,j_rates:-.3,j_consumer:.2,j_foundry:.5,j_regulation:-.3}},
      {ticker:"ASML",name:"ASML",verdict:"long",currentPrice:1407,prices:[800,1000,1200,1500,1750,2050,2500],sens:{j_aicapex:.6,j_china:-.5,j_rates:-.3,j_consumer:.2,j_foundry:.8,j_regulation:-.2}},
      {ticker:"AMAT",name:"Applied Materials",verdict:"long",currentPrice:180,prices:[105,130,158,195,230,275,340],sens:{j_aicapex:.5,j_china:-.5,j_rates:-.2,j_consumer:.3,j_foundry:.7,j_regulation:-.1}},
      {ticker:"MRVL",name:"Marvell Tech",verdict:"long",currentPrice:105,prices:[50,68,88,115,140,175,220],sens:{j_aicapex:.8,j_china:-.2,j_rates:-.4,j_consumer:.2,j_foundry:.4,j_regulation:-.3}},
      {ticker:"ALAB",name:"Astera Labs",verdict:"long",currentPrice:95,prices:[35,52,72,105,140,185,250],sens:{j_aicapex:.9,j_china:-.1,j_rates:-.5,j_consumer:.1,j_foundry:.5,j_regulation:-.2}},
      {ticker:"MU",name:"Micron",verdict:"long",currentPrice:98,prices:[52,68,82,108,130,160,200],sens:{j_aicapex:.7,j_china:-.3,j_rates:-.3,j_consumer:.5,j_foundry:.6,j_regulation:-.1}},
      {ticker:"AMD",name:"AMD",verdict:"short",currentPrice:207,prices:[100,135,175,215,260,310,380],sens:{j_aicapex:-.3,j_china:.2,j_rates:.2,j_consumer:-.2,j_foundry:-.3,j_regulation:.2}},
      {ticker:"INTC",name:"Intel",verdict:"short",currentPrice:24,prices:[10,14,19,25,32,40,52],sens:{j_aicapex:-.4,j_china:.3,j_rates:.3,j_consumer:-.1,j_foundry:-.6,j_regulation:.1}},
      {ticker:"QCOM",name:"Qualcomm",verdict:"short",currentPrice:168,prices:[90,120,148,175,205,240,285],sens:{j_aicapex:-.2,j_china:.4,j_rates:.2,j_consumer:-.4,j_foundry:-.2,j_regulation:.3}},
      {ticker:"ARM",name:"ARM Holdings",verdict:"short",currentPrice:172,prices:[80,110,145,180,220,270,340],sens:{j_aicapex:-.2,j_china:.1,j_rates:.3,j_consumer:-.3,j_foundry:-.2,j_regulation:.4}},
      {ticker:"SMCI",name:"Super Micro",verdict:"short",currentPrice:40,prices:[12,20,30,42,58,78,105],sens:{j_aicapex:-.5,j_china:.2,j_rates:.3,j_consumer:-.1,j_foundry:-.4,j_regulation:.3}},
    ]
  },
  {
    id:"boon", name:"Boon", fullName:"Dave 'Boon' Benton", teamId:"fintech",
    team:"Fintech & Payments", color:"#34d399", icon:"üí≥", file:"boon-v2.html",
    desc:"Digital Payments Revolution",
    driverMap:[
      {driverId:"b_digital",weight:25},{driverId:"b_rates",weight:20},{driverId:"b_consumer",weight:20},
      {driverId:"b_regulation",weight:15},{driverId:"b_crypto",weight:10},{driverId:"b_em",weight:10},
    ],
    drivers:[
      {id:"b_digital",label:"Digital Payment Shift",signal:0.6},
      {id:"b_rates",label:"Rate Environment",signal:-0.3},
      {id:"b_consumer",label:"Consumer Spend",signal:0.3},
      {id:"b_regulation",label:"Regulatory/Cap Risk",signal:-0.4},
      {id:"b_crypto",label:"Crypto/DeFi Momentum",signal:0.2},
      {id:"b_em",label:"EM Fintech Growth",signal:0.5},
    ],
    stocks:[
      {ticker:"V",name:"Visa",verdict:"long",currentPrice:340,prices:[220,260,300,365,420,485,570],sens:{b_digital:.8,b_rates:-.1,b_consumer:.6,b_regulation:-.5,b_crypto:-.1,b_em:.5}},
      {ticker:"MA",name:"Mastercard",verdict:"long",currentPrice:518,prices:[340,400,465,555,640,740,870],sens:{b_digital:.8,b_rates:-.1,b_consumer:.6,b_regulation:-.5,b_crypto:-.1,b_em:.6}},
      {ticker:"ADYEN.AS",name:"Adyen",verdict:"long",currentPrice:1520,prices:[800,1050,1300,1650,1950,2350,2900],sens:{b_digital:.9,b_rates:-.2,b_consumer:.5,b_regulation:-.3,b_crypto:.2,b_em:.7}},
      {ticker:"SOFI",name:"SoFi Technologies",verdict:"long",currentPrice:19.7,prices:[8,12,16,22,28,36,48],sens:{b_digital:.6,b_rates:-.6,b_consumer:.4,b_regulation:-.2,b_crypto:.5,b_em:.3}},
      {ticker:"MELI",name:"MercadoLibre",verdict:"long",currentPrice:2050,prices:[1100,1400,1750,2200,2650,3200,4000],sens:{b_digital:.7,b_rates:-.3,b_consumer:.5,b_regulation:-.2,b_crypto:.4,b_em:.9}},
      {ticker:"COIN",name:"Coinbase",verdict:"long",currentPrice:265,prices:[100,155,215,290,380,500,680],sens:{b_digital:.3,b_rates:-.4,b_consumer:.2,b_regulation:-.3,b_crypto:.9,b_em:.2}},
      {ticker:"AFRM",name:"Affirm",verdict:"long",currentPrice:62,prices:[22,35,48,68,90,120,165],sens:{b_digital:.7,b_rates:-.7,b_consumer:.6,b_regulation:-.4,b_crypto:.3,b_em:.4}},
      {ticker:"NU",name:"Nu Holdings",verdict:"long",currentPrice:12.5,prices:[5.5,7.5,10,13.5,17,22,29],sens:{b_digital:.7,b_rates:-.4,b_consumer:.5,b_regulation:-.2,b_crypto:.3,b_em:.8}},
      {ticker:"PYPL",name:"PayPal",verdict:"short",currentPrice:40,prices:[18,25,33,42,52,64,80],sens:{b_digital:-.3,b_rates:.2,b_consumer:-.2,b_regulation:.3,b_crypto:-.1,b_em:-.2}},
      {ticker:"XYZ",name:"Block (Square)",verdict:"short",currentPrice:72,prices:[32,45,58,75,92,115,145],sens:{b_digital:-.2,b_rates:.1,b_consumer:-.3,b_regulation:.2,b_crypto:.4,b_em:-.1}},
      {ticker:"FIS",name:"Fidelity Nat'l Info",verdict:"short",currentPrice:78,prices:[45,55,66,80,92,108,128],sens:{b_digital:-.5,b_rates:.3,b_consumer:-.1,b_regulation:.4,b_crypto:-.2,b_em:-.3}},
      {ticker:"GPN",name:"Global Payments",verdict:"short",currentPrice:95,prices:[52,65,80,98,115,135,160],sens:{b_digital:-.5,b_rates:.3,b_consumer:-.2,b_regulation:.4,b_crypto:-.1,b_em:-.3}},
      {ticker:"WU",name:"Western Union",verdict:"short",currentPrice:11,prices:[5,6.5,8.5,11,14,17,21],sens:{b_digital:-.8,b_rates:.2,b_consumer:-.3,b_regulation:.3,b_crypto:-.2,b_em:-.7}},
    ]
  },
  {
    id:"oz", name:"Oz", fullName:"Mark 'Oz' Geist", teamId:"healthcare",
    team:"Healthcare & Biotech", color:"#f472b6", icon:"üß¨", file:"oz-v2.html",
    desc:"GLP-1 & Innovation Pipeline",
    driverMap:[
      {driverId:"o_glp1",weight:25},{driverId:"o_pipeline",weight:20},{driverId:"o_pricing",weight:20},
      {driverId:"o_rates",weight:10},{driverId:"o_ma",weight:15},{driverId:"o_aging",weight:10},
    ],
    drivers:[
      {id:"o_glp1",label:"GLP-1/Obesity Momentum",signal:0.6},
      {id:"o_pipeline",label:"Pipeline/FDA Catalysts",signal:0.4},
      {id:"o_pricing",label:"Drug Pricing Pressure",signal:-0.4},
      {id:"o_rates",label:"Rate Environment",signal:-0.2},
      {id:"o_ma",label:"M&A / Dealmaking",signal:0.3},
      {id:"o_aging",label:"Demographics/Aging",signal:0.5},
    ],
    stocks:[
      {ticker:"LLY",name:"Eli Lilly",verdict:"long",currentPrice:920,prices:[580,680,800,985,1150,1350,1600],sens:{o_glp1:.9,o_pipeline:.7,o_pricing:-.4,o_rates:-.2,o_ma:.3,o_aging:.6}},
      {ticker:"ISRG",name:"Intuitive Surgical",verdict:"long",currentPrice:580,prices:[340,410,500,625,740,880,1050],sens:{o_glp1:.2,o_pipeline:.5,o_pricing:-.2,o_rates:-.3,o_ma:.4,o_aging:.8}},
      {ticker:"VRTX",name:"Vertex Pharma",verdict:"long",currentPrice:455,prices:[280,340,400,490,570,670,800],sens:{o_glp1:.1,o_pipeline:.8,o_pricing:-.3,o_rates:-.2,o_ma:.5,o_aging:.4}},
      {ticker:"REGN",name:"Regeneron",verdict:"long",currentPrice:710,prices:[440,530,630,760,880,1030,1220],sens:{o_glp1:.2,o_pipeline:.7,o_pricing:-.3,o_rates:-.1,o_ma:.4,o_aging:.5}},
      {ticker:"TMO",name:"Thermo Fisher",verdict:"long",currentPrice:540,prices:[340,410,480,575,665,780,920],sens:{o_glp1:.3,o_pipeline:.4,o_pricing:-.1,o_rates:-.3,o_ma:.6,o_aging:.6}},
      {ticker:"DXCM",name:"DexCom",verdict:"long",currentPrice:82,prices:[38,52,68,90,115,145,185],sens:{o_glp1:.7,o_pipeline:.5,o_pricing:-.3,o_rates:-.4,o_ma:.3,o_aging:.7}},
      {ticker:"ARGX",name:"argenx",verdict:"long",currentPrice:680,prices:[350,450,570,730,880,1060,1300],sens:{o_glp1:.1,o_pipeline:.9,o_pricing:-.2,o_rates:-.3,o_ma:.6,o_aging:.3}},
      {ticker:"ALNY",name:"Alnylam Pharma",verdict:"long",currentPrice:265,prices:[130,175,225,290,355,430,530],sens:{o_glp1:.1,o_pipeline:.8,o_pricing:-.3,o_rates:-.3,o_ma:.5,o_aging:.4}},
      {ticker:"NVO",name:"Novo Nordisk",verdict:"short",currentPrice:50,prices:[25,32,40,52,65,82,105],sens:{o_glp1:-.4,o_pipeline:-.3,o_pricing:.5,o_rates:.2,o_ma:-.2,o_aging:-.1}},
      {ticker:"UNH",name:"UnitedHealth",verdict:"short",currentPrice:470,prices:[280,340,410,485,560,640,740],sens:{o_glp1:-.3,o_pipeline:-.1,o_pricing:.6,o_rates:.3,o_ma:-.2,o_aging:.3}},
      {ticker:"PFE",name:"Pfizer",verdict:"short",currentPrice:26,prices:[14,18,22,27,32,38,46],sens:{o_glp1:-.2,o_pipeline:-.4,o_pricing:.4,o_rates:.3,o_ma:-.3,o_aging:-.2}},
      {ticker:"MRNA",name:"Moderna",verdict:"short",currentPrice:32,prices:[12,18,25,34,48,68,95],sens:{o_glp1:-.1,o_pipeline:-.5,o_pricing:.3,o_rates:.4,o_ma:-.2,o_aging:-.3}},
      {ticker:"CVS",name:"CVS Health",verdict:"short",currentPrice:56,prices:[32,40,48,58,68,80,95],sens:{o_glp1:-.2,o_pipeline:-.1,o_pricing:.6,o_rates:.2,o_ma:-.3,o_aging:.2}},
    ]
  },
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPUTE OPERATOR STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeOpStats(op, globalDrivers) {
  const results = op.stocks.map(s => {
    const eng = runEngine(s, op.driverMap, globalDrivers);
    return { ...s, eng };
  });
  const longs = results.filter(s => s.verdict === 'long');
  const shorts = results.filter(s => s.verdict === 'short');
  const avgLongRR = longs.length ? longs.reduce((a,s) => a + (s.eng?.rr||0), 0) / longs.length : 0;
  const avgShortRR = shorts.length ? shorts.reduce((a,s) => a + (s.eng?.rr||0), 0) / shorts.length : 0;
  const avgSkew = results.length ? results.reduce((a,s) => a + (s.eng?.skew||0), 0) / results.length : 0;
  const bullPct = globalDrivers.filter(d => op.drivers.some(od => od.id === d.id) && d.signal > 0.3).length;
  const totalD = op.drivers.length;
  let regime = 'NEUTRAL';
  if (avgLongRR > 10) regime = 'BULLISH';
  if (avgLongRR > 20) regime = 'STRONG BULL';
  if (avgLongRR < -5) regime = 'BEARISH';
  if (avgLongRR < -15) regime = 'STRONG BEAR';
  return { results, longs: longs.length, shorts: shorts.length, avgLongRR, avgShortRR, avgSkew, bullPct, totalD, regime };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MICRO COMPONENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Badge({children,color,small,style:sx}){return<span style={{display:'inline-flex',alignItems:'center',padding:small?'1px 6px':'2px 8px',borderRadius:3,fontSize:small?9:10,fontWeight:700,fontFamily:'var(--mono)',letterSpacing:'.04em',background:`${color}15`,color,border:`1px solid ${color}35`,...sx}}>{children}</span>}
function Btn({children,onClick,active,color,style:sx,...p}){const c=color||'var(--fg3)';return<button onClick={onClick} style={{padding:'6px 12px',borderRadius:4,cursor:'pointer',fontSize:11,fontFamily:'var(--mono)',fontWeight:600,transition:'all .15s',border:`1px solid ${active?c+'60':'var(--border)'}`,background:active?c+'12':'transparent',color:active?c:'var(--fg4)',...sx}} {...p}>{children}</button>}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Header({view, setView}) {
  const navItems = [
    {id:'overview', label:'Overview', icon:'‚óâ'},
    {id:'macro', label:'Macro Dashboard', icon:'‚ö°'},
    {id:'operators', label:'Operators', icon:'‚óÜ'},
    {id:'export', label:'Export', icon:'‚Üì'},
  ];
  return <div style={{background:'var(--bg1)',borderBottom:'1px solid var(--border2)',padding:'0 28px',display:'flex',alignItems:'center',gap:0,height:52,flexShrink:0}}>
    <div style={{display:'flex',alignItems:'center',gap:10,marginRight:40}}>
      <div style={{width:8,height:8,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 8px var(--g)',animation:'pulse 2s infinite'}}/>
      <span style={{fontSize:20,fontFamily:'var(--mono)',fontWeight:700,color:'var(--fg)',letterSpacing:'-.02em'}}>XA</span>
      <span style={{fontSize:10,color:'var(--fg4)',fontFamily:'var(--mono)',letterSpacing:'.05em'}}>powered by Upside</span>
    </div>
    <div style={{display:'flex',gap:2}}>
      {navItems.map(n => <button key={n.id} onClick={() => setView(n.id)} style={{
        padding:'14px 16px',fontSize:11,fontFamily:'var(--mono)',fontWeight:600,cursor:'pointer',
        border:'none',background:'transparent',color:view===n.id?'var(--fg)':'var(--fg4)',
        borderBottom:view===n.id?'2px solid var(--g)':'2px solid transparent',
        transition:'all .15s'
      }}>{n.icon} {n.label}</button>)}
    </div>
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function OverviewView({operators, globalDrivers}) {
  const allStats = operators.map(op => ({...op, stats: computeOpStats(op, globalDrivers)}));
  const totalNames = allStats.reduce((a,o) => a + o.stocks.length, 0);
  const totalLongs = allStats.reduce((a,o) => a + o.stats.longs, 0);
  const totalShorts = allStats.reduce((a,o) => a + o.stats.shorts, 0);
  const totalDrivers = allStats.reduce((a,o) => a + o.drivers.length, 0);
  const bullOps = allStats.filter(o => o.stats.avgLongRR > 8).length;

  return <div style={{padding:32,maxWidth:1200,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:32}}>
      <h1 style={{fontSize:32,fontFamily:'var(--serif)',color:'var(--fg)',fontWeight:400,marginBottom:6}}>Command Centre</h1>
      <p style={{fontSize:13,color:'var(--fg3)'}}>GRS Price Target Engine ‚Äî {operators.length} operators across {new Set(operators.map(o=>o.team)).size} sectors</p>
    </div>

    {/* Stats Row */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:12,marginBottom:32}}>
      {[
        ['Operators', operators.length, 'var(--fg)'],
        ['Total Names', totalNames, 'var(--b)'],
        ['Longs', totalLongs, 'var(--g)'],
        ['Shorts', totalShorts, 'var(--r)'],
        ['Macro Drivers', totalDrivers, 'var(--y)'],
        ['Bull Operators', bullOps+'/'+operators.length, 'var(--g2)'],
      ].map(([l,v,c]) => <div key={l} style={{padding:'16px 18px',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:6}}>
        <div style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>{l}</div>
        <div style={{fontSize:22,fontFamily:'var(--mono)',fontWeight:700,color:c}}>{v}</div>
      </div>)}
    </div>

    {/* Operator Cards */}
    <div style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.12em',marginBottom:12}}>Operator Status</div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(340px,1fr))',gap:14}}>
      {allStats.map(op => {
        const s = op.stats;
        const regimeColor = s.regime.includes('BULL') ? 'var(--g)' : s.regime.includes('BEAR') ? 'var(--r)' : 'var(--fg3)';
        return <div key={op.id} style={{background:'var(--bg2)',border:`1px solid ${op.color}20`,borderRadius:8,overflow:'hidden'}}>
          <div style={{padding:'16px 20px',borderBottom:'1px solid var(--border)'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <span style={{fontSize:20}}>{op.icon}</span>
                <div>
                  <span style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
                  <span style={{fontSize:11,color:'var(--fg4)',marginLeft:8}}>{op.team}</span>
                </div>
              </div>
              <Badge color={regimeColor} small>{s.regime}</Badge>
            </div>
            <div style={{fontSize:11,color:'var(--fg3)',marginBottom:8}}>{op.desc}</div>
          </div>
          <div style={{padding:'12px 20px',display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
            <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Names</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{op.stocks.length}</div></div>
            <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>L / S</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600}}><span style={{color:'var(--g)'}}>{s.longs}</span><span style={{color:'var(--fg4)'}}> / </span><span style={{color:'var(--r)'}}>{s.shorts}</span></div></div>
            <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg R/R</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:s.avgLongRR>0?'var(--g)':'var(--r)'}}>{fmt(s.avgLongRR,'pct')}</div></div>
            <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg Skew</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:s.avgSkew>1?'var(--g)':'var(--fg3)'}}>{fmt(s.avgSkew,'ratio')}</div></div>
          </div>
          <div style={{padding:'8px 20px 14px'}}>
            <a href={op.file} target="_blank" rel="noopener" style={{display:'block',textAlign:'center',padding:'8px',fontSize:11,fontFamily:'var(--mono)',fontWeight:700,borderRadius:4,cursor:'pointer',border:`1px solid ${op.color}40`,background:`${op.color}08`,color:op.color,textDecoration:'none',transition:'all .15s'}}>
              Open {op.name} Engine ‚Üí
            </a>
          </div>
        </div>;
      })}
    </div>
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MACRO DASHBOARD (Grouped by Operator) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function MacroView({operators, globalDrivers, setGlobalDrivers}) {
  const [collapsed, setCollapsed] = useState({});
  const toggle = id => setCollapsed(p => ({...p, [id]: !p[id]}));

  const updateSignal = (driverId, val) => {
    setGlobalDrivers(p => p.map(d => d.id === driverId ? {...d, signal: val} : d));
  };

  const bullCount = globalDrivers.filter(d => d.signal > 0.3).length;
  const bearCount = globalDrivers.filter(d => d.signal < -0.3).length;
  const neutralCount = globalDrivers.length - bullCount - bearCount;

  return <div style={{padding:32,maxWidth:1000,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:28}}>
      <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--y)',fontWeight:400,marginBottom:6}}>Macro Dashboard</h1>
      <p style={{fontSize:12,color:'var(--fg4)'}}>Adjust global signals. Changes flow through to all operator engines in real time.</p>
    </div>

    <div style={{display:'flex',gap:12,marginBottom:24}}>
      <Badge color="var(--g)">{bullCount} Bull</Badge>
      <Badge color="var(--fg3)">{neutralCount} Neutral</Badge>
      <Badge color="var(--r)">{bearCount} Bear</Badge>
      <span style={{fontSize:10,color:'var(--fg4)',fontFamily:'var(--mono)',marginLeft:'auto'}}>{globalDrivers.length} drivers across {operators.length} operators</span>
    </div>

    {operators.map(op => {
      const isCollapsed = collapsed[op.id];
      const opDrivers = globalDrivers.filter(gd => op.drivers.some(od => od.id === gd.id));
      const avgSig = opDrivers.length ? opDrivers.reduce((a,d) => a + d.signal, 0) / opDrivers.length : 0;
      const avgColor = avgSig > 0.2 ? 'var(--g)' : avgSig < -0.2 ? 'var(--r)' : 'var(--fg3)';

      return <div key={op.id} style={{marginBottom:12,background:'var(--bg2)',border:`1px solid ${op.color}15`,borderRadius:8,overflow:'hidden'}}>
        <div onClick={() => toggle(op.id)} style={{padding:'14px 20px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom:isCollapsed?'none':'1px solid var(--border)'}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <span style={{fontSize:16}}>{op.icon}</span>
            <span style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
            <span style={{fontSize:11,color:'var(--fg4)'}}>{op.team}</span>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <span style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:600,color:avgColor}}>avg: {avgSig>0?'+':''}{avgSig.toFixed(2)}</span>
            <Badge color={op.color} small>{opDrivers.length} drivers</Badge>
            <span style={{fontSize:14,color:'var(--fg4)',transition:'transform .2s',transform:isCollapsed?'rotate(-90deg)':'rotate(0)'}}>{isCollapsed ? '‚ñ∏' : '‚ñæ'}</span>
          </div>
        </div>
        {!isCollapsed && <div style={{padding:'8px 20px 16px'}}>
          {opDrivers.map(d => {
            const sc = d.signal > 0.3 ? 'var(--g)' : d.signal < -0.3 ? 'var(--r)' : 'var(--fg3)';
            const sl = d.signal > 0.5 ? 'STRONG BULL' : d.signal > 0.2 ? 'BULLISH' : d.signal > -0.2 ? 'NEUTRAL' : d.signal > -0.5 ? 'BEARISH' : 'STRONG BEAR';
            return <div key={d.id} style={{padding:'10px 0',borderBottom:'1px solid var(--border)',display:'grid',gridTemplateColumns:'200px 1fr 100px',gap:16,alignItems:'center'}}>
              <div>
                <div style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{d.label}</div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--r)',width:16,textAlign:'right'}}>-1</span>
                <input type="range" min="-100" max="100" value={Math.round(d.signal*100)} onChange={e => updateSignal(d.id, parseInt(e.target.value)/100)} style={{flex:1,accentColor:sc}}/>
                <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--g)',width:16}}>+1</span>
              </div>
              <div style={{textAlign:'right'}}>
                <span style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:700,color:sc}}>{d.signal>0?'+':''}{d.signal.toFixed(2)}</span>
                <div style={{fontSize:8,fontFamily:'var(--mono)',color:sc,marginTop:1}}>{sl}</div>
              </div>
            </div>;
          })}
        </div>}
      </div>;
    })}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPERATORS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function OperatorsView({operators, globalDrivers}) {
  const allStats = operators.map(op => ({...op, stats: computeOpStats(op, globalDrivers)}));

  return <div style={{padding:32,maxWidth:1200,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:28}}>
      <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--p)',fontWeight:400,marginBottom:6}}>GRS Operators</h1>
      <p style={{fontSize:12,color:'var(--fg4)'}}>Click any operator to open its full interactive engine with scenario sliders, stock cards, and positioning data.</p>
    </div>

    {allStats.map(op => {
      const s = op.stats;
      const topLongs = s.results.filter(r => r.verdict==='long').sort((a,b) => (b.eng?.rr||0)-(a.eng?.rr||0)).slice(0,3);
      const topShorts = s.results.filter(r => r.verdict==='short').sort((a,b) => (a.eng?.rr||0)-(b.eng?.rr||0)).slice(0,3);

      return <div key={op.id} style={{marginBottom:20,background:'var(--bg2)',border:`1px solid ${op.color}15`,borderRadius:8,overflow:'hidden'}}>
        <div style={{padding:'18px 24px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <span style={{fontSize:24}}>{op.icon}</span>
            <div>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <span style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
                <span style={{fontSize:12,color:'var(--fg3)'}}>{op.team}</span>
              </div>
              <div style={{fontSize:11,color:'var(--fg4)',marginTop:2}}>{op.desc}</div>
            </div>
          </div>
          <a href={op.file} target="_blank" rel="noopener" style={{padding:'8px 16px',fontSize:11,fontFamily:'var(--mono)',fontWeight:700,borderRadius:4,cursor:'pointer',border:`1px solid ${op.color}40`,background:`${op.color}08`,color:op.color,textDecoration:'none'}}>
            Open Engine ‚Üí
          </a>
        </div>

        <div style={{padding:'14px 24px',display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:12}}>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Names</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{op.stocks.length}</div></div>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Long R/R</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--g)'}}>{fmt(s.avgLongRR,'pct')}</div></div>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Short R/R</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--r)'}}>{fmt(s.avgShortRR,'pct')}</div></div>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg Skew</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:s.avgSkew>1?'var(--g)':'var(--fg3)'}}>{fmt(s.avgSkew,'ratio')}</div></div>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Drivers</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--y)'}}>{op.drivers.length}</div></div>
          <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Regime</div><div style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:600,color:s.regime.includes('BULL')?'var(--g)':s.regime.includes('BEAR')?'var(--r)':'var(--fg3)'}}>{s.regime}</div></div>
        </div>

        <div style={{padding:'0 24px 16px',display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
          <div>
            <div style={{fontSize:8,color:'var(--g)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>Top Longs by R/R</div>
            {topLongs.map(s => <div key={s.ticker} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'4px 0',fontSize:11,fontFamily:'var(--mono)'}}>
              <span style={{color:'var(--fg)',fontWeight:600}}>{s.ticker}</span>
              <span style={{color:'var(--fg3)'}}>{s.name}</span>
              <span style={{color:'var(--g)',fontWeight:700}}>{fmt(s.eng?.rr,'pct')}</span>
            </div>)}
          </div>
          <div>
            <div style={{fontSize:8,color:'var(--r)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>Top Shorts by R/R</div>
            {topShorts.map(s => <div key={s.ticker} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'4px 0',fontSize:11,fontFamily:'var(--mono)'}}>
              <span style={{color:'var(--fg)',fontWeight:600}}>{s.ticker}</span>
              <span style={{color:'var(--fg3)'}}>{s.name}</span>
              <span style={{color:'var(--r)',fontWeight:700}}>{fmt(s.eng?.rr,'pct')}</span>
            </div>)}
          </div>
        </div>
      </div>;
    })}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function ExportView({operators, globalDrivers}) {
  const [scope, setScope] = useState('all');
  const [selOp, setSelOp] = useState(operators[0]?.id||'');
  const [format, setFormat] = useState('csv');

  const doExport = () => {
    const date = new Date().toISOString().slice(0,10);
    const ops = scope === 'all' ? operators : operators.filter(o => o.id === selOp);
    if (format === 'json') {
      download(JSON.stringify({operators: ops.map(o => ({...o, stats: computeOpStats(o, globalDrivers)})), exported: date}, null, 2), `xa_${scope}_${date}.json`, 'application/json');
    } else {
      const h = ['ticker','name','verdict','operator','team','current_price','ev','rr_pct','skew','engine_verdict','tier',...SCENARIOS.map(s=>`price_${s.label.replace(/\s/g,'_')}`)];
      let csv = h.join(',') + '\n';
      ops.forEach(op => {
        op.stocks.forEach(s => {
          const eng = runEngine(s, op.driverMap, globalDrivers);
          csv += [s.ticker, s.name, s.verdict, op.name, op.team, s.currentPrice, eng?.ev?.toFixed(2)||'', eng?.rr?.toFixed(1)||'', eng?.skew?.toFixed(2)||'', eng?.vd||'', eng?.tier||'', ...(s.prices||[]).map(p=>p)].join(',') + '\n';
        });
      });
      download(csv, `xa_${scope}_${date}.csv`);
    }
  };

  const totalS = operators.reduce((a,o) => a + o.stocks.length, 0);

  return <div style={{padding:32,maxWidth:600,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--b)',fontWeight:400,marginBottom:6}}>Export Centre</h1>
    <p style={{fontSize:12,color:'var(--fg4)',marginBottom:28}}>Export with full engine output for XA-Coach or backup</p>

    <div style={{fontSize:10,fontWeight:700,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:8}}>Scope</div>
    <div style={{display:'flex',gap:6,marginBottom:20}}>
      {[['all',`All Operators (${totalS})`],['single','Single Operator']].map(([v,l]) =>
        <Btn key={v} active={scope===v} color="var(--b)" onClick={() => setScope(v)} style={{flex:1}}>{l}</Btn>)}
    </div>
    {scope==='single' && <div style={{marginBottom:20}}>
      <select value={selOp} onChange={e => setSelOp(e.target.value)} style={{width:'100%',padding:'8px 12px',fontSize:12,fontFamily:'var(--mono)',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:4,color:'var(--fg)',cursor:'pointer'}}>
        {operators.map(o => <option key={o.id} value={o.id}>{o.name} ‚Äî {o.team} ({o.stocks.length})</option>)}
      </select>
    </div>}

    <div style={{fontSize:10,fontWeight:700,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:8}}>Format</div>
    <div style={{display:'flex',gap:6,marginBottom:24}}>
      <Btn active={format==='csv'} color="var(--g)" onClick={() => setFormat('csv')} style={{flex:1}}>CSV (XA-Coach)</Btn>
      <Btn active={format==='json'} color="var(--p)" onClick={() => setFormat('json')} style={{flex:1}}>JSON (Full Backup)</Btn>
    </div>
    <button onClick={doExport} style={{width:'100%',padding:'14px',fontSize:14,fontFamily:'var(--mono)',fontWeight:700,borderRadius:6,cursor:'pointer',border:'none',background:'var(--b)',color:'#000',transition:'all .2s'}}>‚Üì Export</button>
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App() {
  const [view, setView] = useState('overview');

  // Build flat global drivers from all operators
  const defaultDrivers = OPERATORS.flatMap(op => op.drivers.map(d => ({...d, opId: op.id})));
  const [globalDrivers, setGlobalDrivers] = useState(() => LS.get('xa_drivers_v2') || defaultDrivers);

  useEffect(() => { LS.set('xa_drivers_v2', globalDrivers); }, [globalDrivers]);

  const handleReset = () => {
    if (confirm('Reset all macro signals to defaults?')) {
      localStorage.removeItem('xa_drivers_v2');
      setGlobalDrivers(defaultDrivers);
    }
  };

  let content;
  if (view === 'overview') content = <OverviewView operators={OPERATORS} globalDrivers={globalDrivers}/>;
  else if (view === 'macro') content = <MacroView operators={OPERATORS} globalDrivers={globalDrivers} setGlobalDrivers={setGlobalDrivers}/>;
  else if (view === 'operators') content = <OperatorsView operators={OPERATORS} globalDrivers={globalDrivers}/>;
  else if (view === 'export') content = <ExportView operators={OPERATORS} globalDrivers={globalDrivers}/>;

  return <div style={{display:'flex',flexDirection:'column',height:'100vh'}}>
    <Header view={view} setView={setView}/>
    <div style={{flex:1,overflowY:'auto',position:'relative'}}>
      <div style={{position:'absolute',top:10,right:16,zIndex:10}}>
        <button onClick={handleReset} title="Reset signals" style={{background:'transparent',border:'1px solid var(--border)',borderRadius:4,color:'var(--fg4)',cursor:'pointer',padding:'4px 8px',fontSize:9,fontFamily:'var(--mono)'}}>Reset Signals</button>
      </div>
      {content}
    </div>
    <div style={{borderTop:'1px solid var(--border)',padding:'8px 28px',display:'flex',justifyContent:'space-between',alignItems:'center',background:'var(--bg1)',flexShrink:0}}>
      <span style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)'}}>XA Command Centre v2.0 ‚Äî GRS Price Target Engine</span>
      <span style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)'}}>upside-xa.com</span>
    </div>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
