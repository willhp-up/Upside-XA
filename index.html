<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XA ‚Äî Command Centre | Upside</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg0:#04060a;--bg1:#090c14;--bg2:#0e1220;--bg3:#161c2e;--bg4:#1e2640;--fg:#e4e8f4;--fg2:#b4bcd4;--fg3:#7580a0;--fg4:#4a5270;--border:rgba(120,140,200,.08);--border2:rgba(120,140,200,.16);--g:#00e676;--g2:#69f0ae;--r:#ff3d71;--y:#ffc107;--b:#40c4ff;--p:#b388ff;--mono:'JetBrains Mono','Fira Code','Consolas',monospace;--sans:'IBM Plex Sans',-apple-system,BlinkMacSystemFont,sans-serif;--serif:'Instrument Serif',Georgia,serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body,#root{height:100%}
body{background:var(--bg0);color:var(--fg);font-family:var(--sans);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
input,textarea,select{font-family:inherit}input:focus,textarea:focus,select:focus{outline:none;border-color:var(--g)!important}button{font-family:inherit}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes glow{0%,100%{box-shadow:0 0 8px var(--g)}50%{box-shadow:0 0 20px var(--g)}}
</style>
</head>
<body>
<div id="root"></div>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL PRICE MAP ‚Äî runs in regular script, truly global ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.XA_PRICES = {};
window.livePrice = function(ticker, hardcoded) {
  var p = window.XA_PRICES[ticker];
  return p != null ? p : hardcoded;
};
try {
  var pm = JSON.parse(localStorage.getItem('xa_prices'));
  if (pm && Object.keys(pm).length > 0) {
    window.XA_PRICES = pm;
    console.log('[XA boot] Loaded ' + Object.keys(pm).length + ' prices from xa_prices');
  } else {
    var saved = JSON.parse(localStorage.getItem('xa_snap_v3'));
    if (saved && saved.priceMap) {
      window.XA_PRICES = saved.priceMap;
      console.log('[XA boot] Loaded ' + Object.keys(saved.priceMap).length + ' prices from xa_snap_v3');
    }
  }
} catch(e) { console.log('[XA boot] localStorage error:', e); }
</script>
<script type="text/babel">
const{useState,useMemo,useCallback,useEffect,useRef}=React;
const LS={get(k){try{return JSON.parse(localStorage.getItem(k))}catch{return null}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
function download(content,filename,mime='text/csv'){const b=new Blob([content],{type:mime});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=filename;a.click();URL.revokeObjectURL(u)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCENARIO ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SCENARIOS=[
  {id:"db",label:"Deep Bear",color:"#ef4444",bp:5},
  {id:"b",label:"Bear",color:"#f97316",bp:10},
  {id:"mb",label:"Mild Bear",color:"#eab308",bp:15},
  {id:"base",label:"Base",color:"#6366f1",bp:35},
  {id:"mbu",label:"Mild Bull",color:"#22d3ee",bp:20},
  {id:"bu",label:"Bull",color:"#10b981",bp:10},
  {id:"dbu",label:"Deep Bull",color:"#06d6a0",bp:5},
];

function runEngine(stock, macroMap, masterMacros){
  if(!stock.prices||stock.prices.length!==7)return null;
  const mapped=macroMap.filter(m=>m.active!==false);
  const tw=mapped.reduce((s,m)=>s+m.weight,0)||1;
  const bp=SCENARIOS.map(s=>s.bp);
  const sp=bp.map((b,si)=>{
    const dir=si-3;let ms=0;
    mapped.forEach(m=>{
      const mm=masterMacros.find(g=>g.id===m.macroId);
      const sig=mm?mm.signal:0;
      const sens=stock.sens?.[m.macroId]||0;
      ms+=(m.weight/tw)*sig*sens*dir*0.15;
    });
    return Math.max(1,b*(1+ms));
  });
  const tot=sp.reduce((s,p)=>s+p,0);
  const pr=sp.map(p=>(p/tot)*100);
  const ev=pr.reduce((s,p,i)=>s+(p/100)*stock.prices[i],0);
  const c=stock.currentPrice||stock.prices[3];
  const rr=c>0?((ev-c)/c)*100:0;
  const buw=pr.slice(4).reduce((s,p,i)=>s+p*Math.abs(stock.prices[i+4]-ev),0);
  const bew=pr.slice(0,3).reduce((s,p,i)=>s+p*Math.abs(stock.prices[i]-ev),0);
  const skew=bew>0?buw/bew:2;
  let vd="NEUTRAL";
  if(rr>15&&skew>1.2)vd="STRONG LONG";
  else if(rr>8&&skew>0.8)vd="LONG";
  else if(rr<-15&&skew<0.6)vd="STRONG SHORT";
  else if(rr<-8&&skew<0.8)vd="SHORT";
  let tier="Watchlist";
  if(Math.abs(rr)>15)tier="Core";
  else if(Math.abs(rr)>8)tier="Satellite";
  return{pr,ev,rr,skew,vd,tier,c};
}

/* Conviction ‚Üí Price Target mapping */
function getConvictionPT(stock, eng) {
  if (!eng || !stock.prices || stock.prices.length !== 7) return { bullPT: null, bearPT: null, conviction: 'NEUTRAL' };
  const vd = eng.vd;
  let bullIdx = 3, bearIdx = 3, conviction = 'NEUTRAL';
  if (vd === 'STRONG LONG' || vd === 'STRONG SHORT') { bullIdx = 6; bearIdx = 0; conviction = 'STRONG'; }
  else if (vd === 'LONG' || vd === 'SHORT') { bullIdx = 5; bearIdx = 1; conviction = 'MODERATE'; }
  else if (Math.abs(eng.rr) > 3) { bullIdx = 4; bearIdx = 2; conviction = 'MILD'; }
  return { bullPT: stock.prices[bullIdx], bearPT: stock.prices[bearIdx], conviction };
}

const fmt=(v,t)=>{if(v===null||v===undefined||isNaN(v))return'‚Äî';if(t==='pct')return`${v>=0?'+':''}${v.toFixed(1)}%`;if(t==='ratio')return`${v.toFixed(1)}x`;if(t==='price'){if(Math.abs(v)>=10000)return v.toLocaleString('en',{maximumFractionDigits:0});if(Math.abs(v)>=100)return v.toFixed(1);return v.toFixed(2)}return`${v.toFixed(1)}`};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MASTER MACROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MASTER_MACROS_DEFAULT = [
  {id:"rates",   label:"Interest Rates",        category:"Economy",    signal:-0.2},
  {id:"oil",     label:"Oil / Energy Prices",    category:"Economy",    signal:0.1},
  {id:"consumer",label:"Consumer Confidence",    category:"Economy",    signal:0.3},
  {id:"supply",  label:"Supply Chain / CapEx",   category:"Economy",    signal:0.3},
  {id:"geopol",  label:"Geopolitical Escalation",category:"Security",   signal:0.4},
  {id:"defence", label:"NATO / Defence Spend",   category:"Security",   signal:0.7},
  {id:"regulation",label:"Regulatory Environment",category:"Security",  signal:-0.2},
  {id:"semi",    label:"Semiconductor Cycle",    category:"Technology", signal:0.7},
  {id:"ai",      label:"AI / Cloud Demand",      category:"Technology", signal:0.7},
  {id:"fintech", label:"Digital Payments",       category:"Technology", signal:0.5},
  {id:"china",   label:"China Growth & Policy",  category:"Asia",       signal:0.3},
  {id:"fx",      label:"Currency / FX",          category:"Asia",       signal:0.2},
  {id:"flows",   label:"Capital Flows",          category:"Asia",       signal:0.4},
  {id:"reform",  label:"Corporate Reform",       category:"Asia",       signal:0.4},
  {id:"kshape",  label:"K-Shape Divergence",     category:"Sector",     signal:0.6},
  {id:"premium", label:"Premiumisation",         category:"Sector",     signal:0.5},
  {id:"energy_tr",label:"Energy Transition",     category:"Sector",     signal:0.3},
  {id:"healthcare",label:"GLP-1 / Biotech",      category:"Sector",     signal:0.5},
];
const MACRO_CATEGORIES = ["Economy","Security","Technology","Asia","Sector"];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPERATOR REGISTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const OPERATORS = [
  {
    id:"tig", name:"Tig", fullName:"Kris 'Tig' Paronto",
    category:"GRS", team:"Travel", color:"#00e676", icon:"‚úà",
    desc:"K-Shape Travel Divergence",
    macroMap:[
      {macroId:"kshape",weight:25},
      {macroId:"rates",weight:20},
      {macroId:"oil",weight:20},
      {macroId:"consumer",weight:15},
      {macroId:"premium",weight:20}
    ],
    stocks:[
      {ticker:"NAS.OL",name:"Norwegian Air",verdict:"long",currentPrice:12.8,prices:[6.5,8.2,10.5,14.8,17.5,21,26],sens:{kshape:0.8,rates:-0.6,oil:-0.5,consumer:0.7,premium:0.6}},
      {ticker:"IAG.L",name:"IAG (BA/Iberia)",verdict:"long",currentPrice:2.15,prices:[1.1,1.45,1.8,2.5,2.95,3.5,4.2],sens:{kshape:0.7,rates:-0.4,oil:-0.6,consumer:0.6,premium:0.8}},
      {ticker:"EZJ.L",name:"easyJet",verdict:"long",currentPrice:5.4,prices:[2.8,3.6,4.5,6.2,7.4,8.8,11],sens:{kshape:0.6,rates:-0.5,oil:-0.7,consumer:0.5,premium:0.5}},
      {ticker:"THYAO.IS",name:"Turkish Airlines",verdict:"long",currentPrice:282,prices:[140,185,230,320,380,450,560],sens:{kshape:0.5,rates:-0.3,oil:-0.4,consumer:0.4,premium:0.8}},
      {ticker:"QAN.AX",name:"Qantas",verdict:"long",currentPrice:8.9,prices:[4.5,5.8,7.2,10.2,12,14.5,18],sens:{kshape:0.6,rates:-0.3,oil:-0.5,consumer:0.5,premium:0.7}},
      {ticker:"MAR",name:"Marriott",verdict:"long",currentPrice:265,prices:[160,195,230,290,330,380,440],sens:{kshape:0.7,rates:-0.2,oil:-0.1,consumer:0.8,premium:0.8}},
      {ticker:"IHG.L",name:"IHG",verdict:"long",currentPrice:88.5,prices:[52,64,76,98,112,130,155],sens:{kshape:0.7,rates:-0.2,oil:-0.1,consumer:0.7,premium:0.7}},
      {ticker:"BKNG",name:"Booking Holdings",verdict:"long",currentPrice:4450,prices:[2800,3400,3900,4800,5400,6200,7500],sens:{kshape:0.5,rates:-0.2,oil:-0.1,consumer:0.6,premium:0.6}},
      {ticker:"ZURN.SW",name:"Zurich Airport",verdict:"long",currentPrice:205,prices:[130,155,180,225,260,300,360],sens:{kshape:0.4,rates:-0.2,oil:-0.1,consumer:0.5,premium:0.5}},
      {ticker:"WIZZ.L",name:"Wizz Air",verdict:"short",currentPrice:18.5,prices:[6,9.5,13,17,22,28,35],sens:{kshape:-0.8,rates:0.5,oil:0.7,consumer:-0.6,premium:-0.5}},
      {ticker:"RYA.L",name:"Ryanair",verdict:"short",currentPrice:18.8,prices:[8.5,12,15.5,19.5,23,27,32],sens:{kshape:-0.6,rates:0.4,oil:0.6,consumer:-0.4,premium:-0.4}},
      {ticker:"AF.PA",name:"Air France-KLM",verdict:"short",currentPrice:8.2,prices:[2.5,4,5.8,7.8,10.5,13,16],sens:{kshape:-0.7,rates:0.6,oil:0.5,consumer:-0.5,premium:-0.4}},
      {ticker:"LHA.DE",name:"Lufthansa",verdict:"short",currentPrice:6.5,prices:[2,3.2,4.6,6.2,8,10,13],sens:{kshape:-0.6,rates:0.5,oil:0.4,consumer:-0.4,premium:-0.4}},
      {ticker:"WH",name:"Wyndham",verdict:"short",currentPrice:82,prices:[45,55,68,80,95,110,130],sens:{kshape:-0.6,rates:0.3,oil:0.2,consumer:-0.7,premium:-0.5}},
      {ticker:"FRA.DE",name:"Fraport",verdict:"short",currentPrice:52,prices:[28,36,44,54,62,72,85],sens:{kshape:-0.4,rates:0.4,oil:0.2,consumer:-0.3,premium:-0.3}}
    ]
  },
  {
    id:"rone", name:"Rone", fullName:"Mark 'Oz' Geist",
    category:"GRS", team:"Defence", color:"#40c4ff", icon:"üõ°",
    desc:"NATO Rearmament Supercycle",
    macroMap:[
      {macroId:"defence",weight:30},
      {macroId:"geopol",weight:25},
      {macroId:"regulation",weight:15},
      {macroId:"rates",weight:10},
      {macroId:"supply",weight:10},
      {macroId:"oil",weight:10}
    ],
    stocks:[
      {ticker:"BA.L",name:"BAE Systems",verdict:"long",currentPrice:2031,prices:[1400,1650,1850,2200,2450,2750,3200],sens:{defence:0.8,geopol:0.7,regulation:0.5,rates:-0.3,supply:-0.2,oil:-0.1}},
      {ticker:"RHM.DE",name:"Rheinmetall",verdict:"long",currentPrice:1609,prices:[900,1100,1350,1750,2050,2400,3000],sens:{defence:0.9,geopol:0.9,regulation:0.7,rates:-0.4,supply:-0.6,oil:-0.1}},
      {ticker:"SAAB-B.ST",name:"Saab",verdict:"long",currentPrice:657,prices:[380,470,560,720,840,980,1200],sens:{defence:0.8,geopol:0.8,regulation:0.6,rates:-0.2,supply:-0.3,oil:-0.1}},
      {ticker:"HO.PA",name:"Thales",verdict:"long",currentPrice:245,prices:[165,195,220,270,310,360,430],sens:{defence:0.7,geopol:0.6,regulation:0.7,rates:-0.2,supply:-0.2,oil:-0.1}},
      {ticker:"LDO.MI",name:"Leonardo",verdict:"long",currentPrice:54,prices:[30,38,46,60,70,82,100],sens:{defence:0.7,geopol:0.6,regulation:0.6,rates:-0.5,supply:-0.3,oil:-0.1}},
      {ticker:"AIR.PA",name:"Airbus D&S",verdict:"long",currentPrice:192,prices:[130,155,175,210,240,275,330],sens:{defence:0.7,geopol:0.5,regulation:0.8,rates:-0.3,supply:-0.4,oil:-0.1}},
      {ticker:"RR.L",name:"Rolls-Royce",verdict:"long",currentPrice:1271,prices:[800,950,1100,1400,1600,1850,2200],sens:{defence:0.5,geopol:0.4,regulation:0.4,rates:-0.3,supply:-0.3,oil:-0.1}},
      {ticker:"QQ.L",name:"QinetiQ",verdict:"long",currentPrice:474,prices:[320,380,430,520,580,660,780],sens:{defence:0.6,geopol:0.4,regulation:0.3,rates:-0.2,supply:-0.1,oil:0}},
      {ticker:"LMT",name:"Lockheed Martin",verdict:"short",currentPrice:653,prices:[420,500,570,640,720,810,950],sens:{defence:0.3,geopol:0.4,regulation:-0.7,rates:-0.2,supply:-0.1,oil:0}},
      {ticker:"GD",name:"General Dynamics",verdict:"short",currentPrice:360,prices:[240,280,320,365,410,460,530],sens:{defence:0.2,geopol:0.3,regulation:-0.6,rates:-0.3,supply:-0.1,oil:0}},
      {ticker:"HAG.DE",name:"Hensoldt",verdict:"short",currentPrice:81,prices:[40,52,65,78,95,115,145],sens:{defence:0.5,geopol:0.4,regulation:0.3,rates:-0.5,supply:-0.6,oil:0}},
      {ticker:"AVON.L",name:"Avon Protection",verdict:"short",currentPrice:1050,prices:[600,750,900,1050,1200,1400,1700],sens:{defence:0.3,geopol:0.3,regulation:0.1,rates:-0.3,supply:-0.4,oil:0}},
      {ticker:"CHG.L",name:"Chemring",verdict:"short",currentPrice:500,prices:[320,380,440,510,580,660,780],sens:{defence:0.4,geopol:0.3,regulation:0.2,rates:-0.3,supply:-0.5,oil:0}}
    ]
  },
  {
    id:"tanto", name:"Tanto", fullName:"Kris 'Tanto' Paronto",
    category:"GRS", team:"Energy & Commodities", color:"#f59e0b", icon:"üõ¢",
    desc:"Energy Transition Divergence",
    macroMap:[
      {macroId:"oil",weight:25},
      {macroId:"supply",weight:25},
      {macroId:"energy_tr",weight:15},
      {macroId:"rates",weight:10},
      {macroId:"china",weight:15},
      {macroId:"regulation",weight:10}
    ],
    stocks:[
      {ticker:"SHEL",name:"Shell",verdict:"long",currentPrice:78,prices:[48,58,68,85,98,115,140],sens:{oil:0.7,supply:0.6,energy_tr:-0.3,rates:-0.2,china:0.5,regulation:0.7}},
      {ticker:"XOM",name:"ExxonMobil",verdict:"long",currentPrice:149,prices:[95,115,132,160,182,210,250],sens:{oil:0.8,supply:0.5,energy_tr:-0.4,rates:-0.1,china:0.4,regulation:0.8}},
      {ticker:"CVX",name:"Chevron",verdict:"long",currentPrice:184,prices:[115,140,162,195,225,260,310],sens:{oil:0.7,supply:0.5,energy_tr:-0.3,rates:-0.2,china:0.4,regulation:0.9}},
      {ticker:"TTE",name:"TotalEnergies",verdict:"long",currentPrice:77,prices:[45,55,66,82,96,115,140],sens:{oil:0.6,supply:0.5,energy_tr:0.2,rates:-0.2,china:0.5,regulation:0.6}},
      {ticker:"EQNR",name:"Equinor",verdict:"long",currentPrice:28,prices:[16,20,24,30,36,43,52],sens:{oil:0.8,supply:0.6,energy_tr:0.3,rates:-0.1,china:0.3,regulation:0.5}},
      {ticker:"CNQ",name:"Canadian Natural",verdict:"long",currentPrice:28,prices:[15,19,23,30,36,44,55],sens:{oil:0.9,supply:0.4,energy_tr:-0.5,rates:-0.3,china:0.3,regulation:0.8}},
      {ticker:"SU",name:"Suncor Energy",verdict:"long",currentPrice:55,prices:[32,39,47,59,70,84,105],sens:{oil:0.8,supply:0.4,energy_tr:-0.4,rates:-0.2,china:0.3,regulation:0.7}},
      {ticker:"VET",name:"Vermilion Energy",verdict:"long",currentPrice:9.5,prices:[4,5.5,7.5,11,14,18,24],sens:{oil:0.9,supply:0.5,energy_tr:-0.6,rates:-0.4,china:0.4,regulation:0.6}},
      {ticker:"BP",name:"BP",verdict:"short",currentPrice:39,prices:[18,24,31,38,48,58,72],sens:{oil:-0.5,supply:-0.4,energy_tr:0.3,rates:0.3,china:-0.3,regulation:-0.7}},
      {ticker:"OXY",name:"Occidental",verdict:"short",currentPrice:46,prices:[22,30,38,48,56,66,80],sens:{oil:-0.6,supply:-0.3,energy_tr:-0.2,rates:0.2,china:-0.2,regulation:-0.8}},
      {ticker:"RIG",name:"Transocean",verdict:"short",currentPrice:3.8,prices:[1,1.8,2.8,4,5.5,7.5,10],sens:{oil:-0.8,supply:-0.5,energy_tr:-0.6,rates:0.5,china:-0.4,regulation:-0.5}},
      {ticker:"HAL",name:"Halliburton",verdict:"short",currentPrice:24,prices:[12,16,20,25,30,36,44],sens:{oil:-0.6,supply:-0.4,energy_tr:-0.3,rates:0.2,china:-0.3,regulation:-0.4}},
      {ticker:"PBR",name:"Petrobras",verdict:"short",currentPrice:15,prices:[7,9.5,12.5,15.5,19,23,28],sens:{oil:-0.5,supply:-0.3,energy_tr:-0.1,rates:0.4,china:-0.5,regulation:-0.3}}
    ]
  },
  {
    id:"jack", name:"Jack", fullName:"Jack Silva",
    category:"GRS", team:"AI & Semiconductors", color:"#818cf8", icon:"üß†",
    desc:"AI Capex Supercycle",
    macroMap:[
      {macroId:"ai",weight:30},
      {macroId:"china",weight:20},
      {macroId:"rates",weight:15},
      {macroId:"consumer",weight:10},
      {macroId:"semi",weight:15},
      {macroId:"regulation",weight:10}
    ],
    stocks:[
      {ticker:"NVDA",name:"NVIDIA",verdict:"long",currentPrice:183,prices:[95,125,155,200,240,290,360],sens:{ai:0.9,china:-0.4,rates:-0.3,consumer:0.3,semi:0.6,regulation:-0.4}},
      {ticker:"TSM",name:"TSMC",verdict:"long",currentPrice:366,prices:[200,260,320,400,475,560,680],sens:{ai:0.7,china:-0.6,rates:-0.2,consumer:0.4,semi:0.9,regulation:-0.2}},
      {ticker:"AVGO",name:"Broadcom",verdict:"long",currentPrice:325,prices:[180,235,285,355,420,500,620],sens:{ai:0.8,china:-0.3,rates:-0.3,consumer:0.2,semi:0.5,regulation:-0.3}},
      {ticker:"ASML",name:"ASML",verdict:"long",currentPrice:1407,prices:[800,1000,1200,1500,1750,2050,2500],sens:{ai:0.6,china:-0.5,rates:-0.3,consumer:0.2,semi:0.8,regulation:-0.2}},
      {ticker:"AMAT",name:"Applied Materials",verdict:"long",currentPrice:180,prices:[105,130,158,195,230,275,340],sens:{ai:0.5,china:-0.5,rates:-0.2,consumer:0.3,semi:0.7,regulation:-0.1}},
      {ticker:"MRVL",name:"Marvell Tech",verdict:"long",currentPrice:105,prices:[50,68,88,115,140,175,220],sens:{ai:0.8,china:-0.2,rates:-0.4,consumer:0.2,semi:0.4,regulation:-0.3}},
      {ticker:"ALAB",name:"Astera Labs",verdict:"long",currentPrice:95,prices:[35,52,72,105,140,185,250],sens:{ai:0.9,china:-0.1,rates:-0.5,consumer:0.1,semi:0.5,regulation:-0.2}},
      {ticker:"MU",name:"Micron",verdict:"long",currentPrice:98,prices:[52,68,82,108,130,160,200],sens:{ai:0.7,china:-0.3,rates:-0.3,consumer:0.5,semi:0.6,regulation:-0.1}},
      {ticker:"AMD",name:"AMD",verdict:"short",currentPrice:207,prices:[100,135,175,215,260,310,380],sens:{ai:-0.3,china:0.2,rates:0.2,consumer:-0.2,semi:-0.3,regulation:0.2}},
      {ticker:"INTC",name:"Intel",verdict:"short",currentPrice:24,prices:[10,14,19,25,32,40,52],sens:{ai:-0.4,china:0.3,rates:0.3,consumer:-0.1,semi:-0.6,regulation:0.1}},
      {ticker:"QCOM",name:"Qualcomm",verdict:"short",currentPrice:168,prices:[90,120,148,175,205,240,285],sens:{ai:-0.2,china:0.4,rates:0.2,consumer:-0.4,semi:-0.2,regulation:0.3}},
      {ticker:"ARM",name:"ARM Holdings",verdict:"short",currentPrice:172,prices:[80,110,145,180,220,270,340],sens:{ai:-0.2,china:0.1,rates:0.3,consumer:-0.3,semi:-0.2,regulation:0.4}},
      {ticker:"SMCI",name:"Super Micro",verdict:"short",currentPrice:40,prices:[12,20,30,42,58,78,105],sens:{ai:-0.5,china:0.2,rates:0.3,consumer:-0.1,semi:-0.4,regulation:0.3}}
    ]
  },
  {
    id:"boon", name:"Boon", fullName:"Dave 'Boon' Benton",
    category:"GRS", team:"Fintech & Payments", color:"#34d399", icon:"üí≥",
    desc:"Digital Payments Revolution",
    macroMap:[
      {macroId:"fintech",weight:30},
      {macroId:"rates",weight:20},
      {macroId:"consumer",weight:20},
      {macroId:"regulation",weight:15},
      {macroId:"flows",weight:15}
    ],
    stocks:[
      {ticker:"V",name:"Visa",verdict:"long",currentPrice:340,prices:[220,260,300,365,420,485,570],sens:{rates:-0.1,consumer:0.6,regulation:-0.5,flows:0.5,fintech:0.4}},
      {ticker:"MA",name:"Mastercard",verdict:"long",currentPrice:518,prices:[340,400,465,555,640,740,870],sens:{rates:-0.1,consumer:0.6,regulation:-0.5,flows:0.6,fintech:0.4}},
      {ticker:"ADYEN.AS",name:"Adyen",verdict:"long",currentPrice:1520,prices:[800,1050,1300,1650,1950,2350,2900],sens:{rates:-0.2,consumer:0.5,regulation:-0.3,flows:0.7,fintech:0.6}},
      {ticker:"SOFI",name:"SoFi Technologies",verdict:"long",currentPrice:19.7,prices:[8,12,16,22,28,36,48],sens:{rates:-0.6,consumer:0.4,regulation:-0.2,flows:0.3,fintech:0.6}},
      {ticker:"MELI",name:"MercadoLibre",verdict:"long",currentPrice:2050,prices:[1100,1400,1750,2200,2650,3200,4000],sens:{rates:-0.3,consumer:0.5,regulation:-0.2,flows:0.9,fintech:0.6}},
      {ticker:"COIN",name:"Coinbase",verdict:"long",currentPrice:265,prices:[100,155,215,290,380,500,680],sens:{rates:-0.4,consumer:0.2,regulation:-0.3,flows:0.2,fintech:0.6}},
      {ticker:"AFRM",name:"Affirm",verdict:"long",currentPrice:62,prices:[22,35,48,68,90,120,165],sens:{rates:-0.7,consumer:0.6,regulation:-0.4,flows:0.4,fintech:0.5}},
      {ticker:"NU",name:"Nu Holdings",verdict:"long",currentPrice:12.5,prices:[5.5,7.5,10,13.5,17,22,29],sens:{rates:-0.4,consumer:0.5,regulation:-0.2,flows:0.8,fintech:0.5}},
      {ticker:"PYPL",name:"PayPal",verdict:"short",currentPrice:40,prices:[18,25,33,42,52,64,80],sens:{rates:0.2,consumer:-0.2,regulation:0.3,flows:-0.2,fintech:-0.2}},
      {ticker:"XYZ",name:"Block (Square)",verdict:"short",currentPrice:72,prices:[32,45,58,75,92,115,145],sens:{rates:0.1,consumer:-0.3,regulation:0.2,flows:-0.1,fintech:0.1}},
      {ticker:"FIS",name:"Fidelity Nat'l Info",verdict:"short",currentPrice:78,prices:[45,55,66,80,92,108,128],sens:{rates:0.3,consumer:-0.1,regulation:0.4,flows:-0.3,fintech:-0.3}},
      {ticker:"GPN",name:"Global Payments",verdict:"short",currentPrice:95,prices:[52,65,80,98,115,135,160],sens:{rates:0.3,consumer:-0.2,regulation:0.4,flows:-0.3,fintech:-0.3}},
      {ticker:"WU",name:"Western Union",verdict:"short",currentPrice:11,prices:[5,6.5,8.5,11,14,17,21],sens:{rates:0.2,consumer:-0.3,regulation:0.3,flows:-0.7,fintech:-0.5}}
    ]
  },
  {
    id:"oz", name:"Oz", fullName:"Mark 'Oz' Geist",
    category:"GRS", team:"Healthcare & Biotech", color:"#f472b6", icon:"üß¨",
    desc:"GLP-1 & Innovation Pipeline",
    macroMap:[
      {macroId:"healthcare",weight:35},
      {macroId:"regulation",weight:20},
      {macroId:"rates",weight:10},
      {macroId:"flows",weight:15},
      {macroId:"consumer",weight:20}
    ],
    stocks:[
      {ticker:"LLY",name:"Eli Lilly",verdict:"long",currentPrice:920,prices:[580,680,800,985,1150,1350,1600],sens:{regulation:-0.4,rates:-0.2,flows:0.3,consumer:0.6,healthcare:0.8}},
      {ticker:"ISRG",name:"Intuitive Surgical",verdict:"long",currentPrice:580,prices:[340,410,500,625,740,880,1050],sens:{regulation:-0.2,rates:-0.3,flows:0.4,consumer:0.8,healthcare:0.4}},
      {ticker:"VRTX",name:"Vertex Pharma",verdict:"long",currentPrice:455,prices:[280,340,400,490,570,670,800],sens:{regulation:-0.3,rates:-0.2,flows:0.5,consumer:0.4,healthcare:0.5}},
      {ticker:"REGN",name:"Regeneron",verdict:"long",currentPrice:710,prices:[440,530,630,760,880,1030,1220],sens:{regulation:-0.3,rates:-0.1,flows:0.4,consumer:0.5,healthcare:0.5}},
      {ticker:"TMO",name:"Thermo Fisher",verdict:"long",currentPrice:540,prices:[340,410,480,575,665,780,920],sens:{regulation:-0.1,rates:-0.3,flows:0.6,consumer:0.6,healthcare:0.4}},
      {ticker:"DXCM",name:"DexCom",verdict:"long",currentPrice:82,prices:[38,52,68,90,115,145,185],sens:{regulation:-0.3,rates:-0.4,flows:0.3,consumer:0.7,healthcare:0.6}},
      {ticker:"ARGX",name:"argenx",verdict:"long",currentPrice:680,prices:[350,450,570,730,880,1060,1300],sens:{regulation:-0.2,rates:-0.3,flows:0.6,consumer:0.3,healthcare:0.5}},
      {ticker:"ALNY",name:"Alnylam Pharma",verdict:"long",currentPrice:265,prices:[130,175,225,290,355,430,530],sens:{regulation:-0.3,rates:-0.3,flows:0.5,consumer:0.4,healthcare:0.5}},
      {ticker:"NVO",name:"Novo Nordisk",verdict:"short",currentPrice:50,prices:[25,32,40,52,65,82,105],sens:{regulation:0.5,rates:0.2,flows:-0.2,consumer:-0.1,healthcare:-0.3}},
      {ticker:"UNH",name:"UnitedHealth",verdict:"short",currentPrice:470,prices:[280,340,410,485,560,640,740],sens:{regulation:0.6,rates:0.3,flows:-0.2,consumer:0.3,healthcare:-0.2}},
      {ticker:"PFE",name:"Pfizer",verdict:"short",currentPrice:26,prices:[14,18,22,27,32,38,46],sens:{regulation:0.4,rates:0.3,flows:-0.3,consumer:-0.2,healthcare:-0.3}},
      {ticker:"MRNA",name:"Moderna",verdict:"short",currentPrice:32,prices:[12,18,25,34,48,68,95],sens:{regulation:0.3,rates:0.4,flows:-0.2,consumer:-0.3,healthcare:-0.3}},
      {ticker:"CVS",name:"CVS Health",verdict:"short",currentPrice:56,prices:[32,40,48,58,68,80,95],sens:{regulation:0.6,rates:0.2,flows:-0.3,consumer:0.2,healthcare:-0.2}}
    ]
  },
  {
    id:"ipm", name:"Ip Man", fullName:"Ip Man (ËëâÂïè)",
    category:"Asian GRS", team:"Pan Asian Thematic", color:"#ff6b35", icon:"üêâ",
    desc:"15-5 Plan ¬∑ CNY Appreciation ¬∑ Capital Account Opening",
    macroMap:[
      {macroId:"fx",weight:25},
      {macroId:"china",weight:20},
      {macroId:"flows",weight:25},
      {macroId:"consumer",weight:15},
      {macroId:"geopol",weight:15}
    ],
    stocks:[
      {ticker:"1801.HK",name:"Innovent Biologics",verdict:"long",currentPrice:84,prices:[42,55,68,92,112,138,175],sens:{fx:0.6,china:0.9,consumer:0.3,geopol:-0.4,flows:0.5}},
      {ticker:"2269.HK",name:"WuXi Biologics",verdict:"long",currentPrice:40.5,prices:[20,26,33,44,54,66,82],sens:{fx:0.5,china:0.8,consumer:0.2,geopol:-0.6,flows:0.5}},
      {ticker:"300760.SZ",name:"Mindray Medical",verdict:"long",currentPrice:186,prices:[105,130,158,205,245,295,360],sens:{fx:0.4,china:0.8,consumer:0.6,geopol:-0.2,flows:0.4}},
      {ticker:"1211.HK",name:"BYD",verdict:"long",currentPrice:90,prices:[48,60,75,98,120,148,185],sens:{fx:0.7,china:0.7,consumer:0.7,geopol:-0.5,flows:0.4}},
      {ticker:"3750.HK",name:"CATL",verdict:"long",currentPrice:532,prices:[290,360,445,575,680,810,1000],sens:{fx:0.6,china:0.9,consumer:0.2,geopol:-0.3,flows:0.4}},
      {ticker:"0700.HK",name:"Tencent",verdict:"long",currentPrice:533,prices:[310,380,460,575,680,800,960],sens:{fx:0.5,china:0.5,consumer:0.8,geopol:-0.4,flows:0.6}},
      {ticker:"9988.HK",name:"Alibaba",verdict:"long",currentPrice:155,prices:[82,105,130,170,210,260,325],sens:{fx:0.5,china:0.4,consumer:0.7,geopol:-0.5,flows:0.6}},
      {ticker:"3690.HK",name:"Meituan",verdict:"short",currentPrice:82,prices:[42,55,68,85,105,130,165],sens:{fx:-0.2,china:-0.3,consumer:-0.6,geopol:0.2,flows:0.3}},
      {ticker:"0175.HK",name:"Geely Auto",verdict:"short",currentPrice:16,prices:[6.5,9,12,15.5,19.5,24,30],sens:{fx:-0.4,china:-0.5,consumer:-0.4,geopol:0.3,flows:0.2}},
      {ticker:"601012.SH",name:"LONGi Green Energy",verdict:"short",currentPrice:18,prices:[6,9,13,17,22,28,36],sens:{fx:-0.3,china:0.2,consumer:-0.2,geopol:0.4,flows:0}},
      {ticker:"2382.HK",name:"Sunny Optical",verdict:"short",currentPrice:65,prices:[28,38,50,63,78,96,120],sens:{fx:-0.3,china:-0.2,consumer:-0.5,geopol:0.5,flows:0.2}}
    ]
  },
  {
    id:"miu", name:"Miura", fullName:"Miura (‰∏âÊµ¶)",
    category:"Asian GRS", team:"Pan Asian Thematic", color:"#e11d48", icon:"‚õ©Ô∏è",
    desc:"JPY Appreciation ¬∑ Foreign Inflows ¬∑ Takaichi Admin ¬∑ Defence Buildup",
    macroMap:[
      {macroId:"fx",weight:25},
      {macroId:"flows",weight:20},
      {macroId:"reform",weight:20},
      {macroId:"china",weight:15},
      {macroId:"rates",weight:10},
      {macroId:"defence",weight:10}
    ],
    stocks:[
      {ticker:"8306.T",name:"Mitsubishi UFJ",verdict:"long",currentPrice:2877,prices:[1600,2000,2450,3100,3650,4300,5200],sens:{fx:0.7,flows:0.8,reform:0.5,china:-0.2,rates:0.9,defence:0.1}},
      {ticker:"8035.T",name:"Tokyo Electron",verdict:"long",currentPrice:42150,prices:[22000,28000,35000,45000,55000,68000,85000],sens:{fx:0.3,flows:0.7,reform:0.4,china:-0.4,rates:0.2,defence:0.1}},
      {ticker:"7012.T",name:"Kawasaki Heavy",verdict:"long",currentPrice:16940,prices:[8500,11000,14000,18500,23000,29000,37000],sens:{fx:0.3,flows:0.4,reform:0.7,china:0.5,rates:0.1,defence:0.9}},
      {ticker:"7011.T",name:"Mitsubishi Heavy",verdict:"long",currentPrice:4820,prices:[2500,3200,4000,5200,6400,7800,9500],sens:{fx:0.3,flows:0.5,reform:0.6,china:0.4,rates:0.1,defence:0.9}},
      {ticker:"9984.T",name:"SoftBank Group",verdict:"long",currentPrice:4449,prices:[2200,2900,3700,4800,6000,7500,9500],sens:{fx:0.4,flows:0.8,reform:0.3,china:-0.3,rates:0.2,defence:0}},
      {ticker:"6098.T",name:"Recruit Holdings",verdict:"long",currentPrice:10200,prices:[5500,7000,8600,11000,13500,16500,20000],sens:{fx:0.5,flows:0.6,reform:0.5,china:-0.1,rates:0.3,defence:0}},
      {ticker:"6146.T",name:"DISCO Corp",verdict:"long",currentPrice:48000,prices:[25000,32000,40000,52000,65000,82000,105000],sens:{fx:0.3,flows:0.7,reform:0.3,china:-0.3,rates:0.2,defence:0}},
      {ticker:"7203.T",name:"Toyota Motor",verdict:"short",currentPrice:3200,prices:[1500,2000,2600,3100,3800,4600,5600],sens:{fx:-0.8,flows:0.2,reform:-0.3,china:-0.4,rates:-0.2,defence:0}},
      {ticker:"6752.T",name:"Panasonic",verdict:"short",currentPrice:1800,prices:[850,1100,1450,1750,2150,2600,3200],sens:{fx:-0.5,flows:0.1,reform:-0.2,china:-0.3,rates:-0.3,defence:0}},
      {ticker:"7267.T",name:"Honda Motor",verdict:"short",currentPrice:1550,prices:[750,950,1250,1500,1850,2250,2800],sens:{fx:-0.7,flows:0.1,reform:-0.2,china:-0.5,rates:-0.2,defence:0}},
      {ticker:"8058.T",name:"Mitsubishi Corp",verdict:"short",currentPrice:3787,prices:[1900,2400,3100,3700,4500,5400,6600],sens:{fx:-0.5,flows:0.3,reform:-0.1,china:-0.3,rates:-0.1,defence:0.2}}
    ]
  },
  {
    id:"ctc", name:"Cheung Tin-chi", fullName:"Cheung Tin-chi (ÂºµÂ§©Âøó)",
    category:"Asian GRS", team:"Pan Asian Thematic", color:"#0ea5e9", icon:"üî¨",
    desc:"Semiconductor Dominance ¬∑ TWD Risk ¬∑ Domestic Wealth ¬∑ Geopolitical Premium",
    macroMap:[
      {macroId:"semi",weight:30},
      {macroId:"fx",weight:20},
      {macroId:"flows",weight:15},
      {macroId:"geopol",weight:15},
      {macroId:"ai",weight:10},
      {macroId:"rates",weight:10}
    ],
    stocks:[
      {ticker:"2330.TW",name:"TSMC",verdict:"long",currentPrice:1915,prices:[1050,1300,1600,2050,2500,3050,3800],sens:{semi:0.9,fx:-0.2,flows:0.3,geopol:-0.6,ai:0.9,rates:0.2}},
      {ticker:"2454.TW",name:"MediaTek",verdict:"long",currentPrice:1855,prices:[1000,1250,1550,2000,2450,3000,3700],sens:{semi:0.8,fx:-0.1,flows:0.2,geopol:-0.3,ai:0.8,rates:0.2}},
      {ticker:"3711.TW",name:"ASE Technology",verdict:"long",currentPrice:293,prices:[155,195,245,315,385,470,580],sens:{semi:0.8,fx:-0.2,flows:0.1,geopol:-0.3,ai:0.7,rates:0.1}},
      {ticker:"2308.TW",name:"Delta Electronics",verdict:"long",currentPrice:420,prices:[220,280,350,450,560,690,850],sens:{semi:0.5,fx:-0.1,flows:0.3,geopol:-0.2,ai:0.6,rates:0.2}},
      {ticker:"6488.TW",name:"GlobalWafers",verdict:"long",currentPrice:550,prices:[280,360,460,590,730,900,1120],sens:{semi:0.9,fx:-0.1,flows:0.1,geopol:-0.3,ai:0.7,rates:0.1}},
      {ticker:"3008.TW",name:"LARGAN Precision",verdict:"long",currentPrice:2600,prices:[1400,1800,2200,2800,3400,4200,5200],sens:{semi:0.6,fx:-0.2,flows:0.2,geopol:-0.2,ai:0.4,rates:0.1}},
      {ticker:"2882.TW",name:"Cathay Financial",verdict:"short",currentPrice:78,prices:[38,50,63,76,92,112,138],sens:{semi:0.1,fx:-0.8,flows:0.3,geopol:-0.2,ai:0,rates:-0.7}},
      {ticker:"2881.TW",name:"Fubon Financial",verdict:"short",currentPrice:95,prices:[48,62,78,93,115,140,172],sens:{semi:0.1,fx:-0.8,flows:0.3,geopol:-0.2,ai:0,rates:-0.7}},
      {ticker:"2891.TW",name:"CTBC Financial",verdict:"short",currentPrice:42,prices:[20,26,34,41,50,62,76],sens:{semi:0.1,fx:-0.6,flows:0.2,geopol:-0.2,ai:0,rates:-0.5}},
      {ticker:"2303.TW",name:"United Micro",verdict:"short",currentPrice:62,prices:[30,40,52,61,74,90,110],sens:{semi:0.3,fx:-0.3,flows:0.1,geopol:-0.3,ai:-0.2,rates:0.1}}
    ]
  },
  {
    id:"wzh", name:"Wan Zonghua", fullName:"Wan Zonghua (Ëê¨ÂÆóËèØ)",
    category:"Asian GRS", team:"Pan Asian Thematic", color:"#8b5cf6", icon:"‚öîÔ∏è",
    desc:"HBM Supercycle ¬∑ Value-Up Programme ¬∑ Regional Flows ¬∑ K-Defence",
    macroMap:[
      {macroId:"semi",weight:25},
      {macroId:"reform",weight:20},
      {macroId:"flows",weight:15},
      {macroId:"china",weight:15},
      {macroId:"defence",weight:15},
      {macroId:"fx",weight:10}
    ],
    stocks:[
      {ticker:"005930.KS",name:"Samsung Electronics",verdict:"long",currentPrice:181200,prices:[95000,120000,152000,195000,240000,300000,380000],sens:{semi:0.9,reform:0.6,flows:0.5,china:-0.3,defence:0,fx:0.3}},
      {ticker:"000660.KS",name:"SK Hynix",verdict:"long",currentPrice:880000,prices:[450000,580000,730000,950000,1180000,1460000,1850000],sens:{semi:0.9,reform:0.4,flows:0.5,china:-0.2,defence:0,fx:0.3}},
      {ticker:"105560.KS",name:"KB Financial",verdict:"long",currentPrice:167900,prices:[88000,110000,140000,180000,225000,280000,350000],sens:{semi:0.1,reform:0.9,flows:0.6,china:-0.1,defence:0,fx:0.4}},
      {ticker:"035420.KS",name:"Naver",verdict:"long",currentPrice:252500,prices:[130000,165000,210000,270000,340000,420000,530000],sens:{semi:0.3,reform:0.3,flows:0.5,china:-0.2,defence:0,fx:0.2}},
      {ticker:"012450.KS",name:"Hanwha Aerospace",verdict:"long",currentPrice:1105000,prices:[580000,720000,920000,1200000,1500000,1880000,2400000],sens:{semi:0,reform:0.3,flows:0.4,china:0.3,defence:0.9,fx:0.2}},
      {ticker:"000270.KS",name:"Kia Corp",verdict:"long",currentPrice:164100,prices:[85000,108000,138000,175000,218000,270000,340000],sens:{semi:0.1,reform:0.7,flows:0.4,china:-0.3,defence:0,fx:0.3}},
      {ticker:"005380.KS",name:"Hyundai Motor",verdict:"short",currentPrice:499000,prices:[250000,320000,410000,490000,600000,740000,920000],sens:{semi:0,reform:-0.5,flows:0.2,china:-0.3,defence:0,fx:-0.3}},
      {ticker:"010140.KS",name:"Samsung Heavy",verdict:"short",currentPrice:13500,prices:[5500,7500,10500,13000,16500,21000,27000],sens:{semi:0,reform:-0.3,flows:0.1,china:-0.4,defence:0.2,fx:-0.4}},
      {ticker:"009540.KS",name:"HD Hyundai Heavy",verdict:"short",currentPrice:185000,prices:[85000,115000,150000,180000,225000,280000,355000],sens:{semi:0,reform:-0.2,flows:0.1,china:-0.3,defence:0.3,fx:-0.3}},
      {ticker:"066570.KS",name:"LG Electronics",verdict:"short",currentPrice:92000,prices:[42000,56000,74000,90000,112000,140000,178000],sens:{semi:0.2,reform:-0.4,flows:0.1,china:-0.4,defence:0,fx:-0.2}}
    ]
  },
  {
    id:"frk", name:"Frank", fullName:"Frank",
    category:"Asian GRS", team:"Pan Asian Thematic", color:"#14b8a6", icon:"ü¶Å",
    desc:"US-China Intermediary ¬∑ Regional Capital Hub ¬∑ ASEAN Growth ¬∑ Financial Services",
    macroMap:[
      {macroId:"china",weight:25},
      {macroId:"flows",weight:20},
      {macroId:"consumer",weight:15},
      {macroId:"fintech",weight:15},
      {macroId:"rates",weight:15},
      {macroId:"fx",weight:10}
    ],
    stocks:[
      {ticker:"D05.SI",name:"DBS Group",verdict:"long",currentPrice:56.89,prices:[32,40,48,61,74,90,110],sens:{china:0.6,flows:0.8,consumer:0.5,fintech:0.9,rates:0.6,fx:0.4}},
      {ticker:"O39.SI",name:"OCBC Bank",verdict:"long",currentPrice:21.11,prices:[12,15,18,23,28,34,42],sens:{china:0.5,flows:0.7,consumer:0.5,fintech:0.8,rates:0.6,fx:0.4}},
      {ticker:"U11.SI",name:"UOB",verdict:"long",currentPrice:38.39,prices:[21,26,33,41,50,62,76],sens:{china:0.5,flows:0.7,consumer:0.6,fintech:0.8,rates:0.5,fx:0.3}},
      {ticker:"A17U.SI",name:"CapitaLand Ascendas REIT",verdict:"long",currentPrice:2.71,prices:[1.5,1.9,2.35,2.9,3.5,4.2,5.1],sens:{china:0.4,flows:0.7,consumer:0.6,fintech:0.3,rates:-0.4,fx:0.2}},
      {ticker:"BN4.SI",name:"Keppel Ltd",verdict:"long",currentPrice:7.5,prices:[4,5,6.3,8.1,10,12.3,15.2],sens:{china:0.5,flows:0.6,consumer:0.7,fintech:0.3,rates:-0.2,fx:0.2}},
      {ticker:"SE",name:"Sea Ltd",verdict:"long",currentPrice:145,prices:[75,95,120,155,195,245,310],sens:{china:0.3,flows:0.4,consumer:0.9,fintech:0.4,rates:0.2,fx:0.1}},
      {ticker:"Z74.SI",name:"Singtel",verdict:"short",currentPrice:4.84,prices:[2.5,3.2,4,4.8,5.8,7,8.5],sens:{china:-0.1,flows:0.2,consumer:0.3,fintech:0.1,rates:-0.3,fx:-0.2}},
      {ticker:"C6L.SI",name:"Singapore Airlines",verdict:"short",currentPrice:7,prices:[3.5,4.5,5.8,6.9,8.4,10.2,12.5],sens:{china:-0.2,flows:0.3,consumer:0.4,fintech:0,rates:-0.2,fx:-0.4}},
      {ticker:"F34.SI",name:"Wilmar International",verdict:"short",currentPrice:3.2,prices:[1.6,2.1,2.7,3.15,3.85,4.7,5.8],sens:{china:-0.3,flows:0.1,consumer:0.3,fintech:0,rates:-0.1,fx:-0.3}},
      {ticker:"S68.SI",name:"SGX Ltd",verdict:"short",currentPrice:13.5,prices:[7,9,11.5,13.3,16,19.5,24],sens:{china:0.2,flows:0.4,consumer:0.2,fintech:0.5,rates:-0.2,fx:0.1}}
    ]
  }
];

/* ‚ïê‚ïê‚ïê PATCH: Apply saved snap prices into OPERATORS before React renders ‚ïê‚ïê‚ïê */
(function() {
  const pm = window.XA_PRICES;
  if (pm && typeof pm === 'object') {
    let patched = 0;
    OPERATORS.forEach(function(op) {
      op.stocks.forEach(function(s) {
        if (pm[s.ticker] != null) { s.currentPrice = pm[s.ticker]; patched++; }
      });
    });
    if (patched > 0) console.log('[XA patch] Patched ' + patched + ' stock prices from saved snap');
  }
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPUTE OPERATOR STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeOpStats(op, masterMacros) {
  const results = op.stocks.map(s => {
    const eng = runEngine(s, op.macroMap, masterMacros);
    return { ...s, eng };
  });
  const longs = results.filter(s => s.verdict === 'long');
  const shorts = results.filter(s => s.verdict === 'short');
  const avgLongRR = longs.length ? longs.reduce((a,s) => a + (s.eng?.rr||0), 0) / longs.length : 0;
  const avgShortRR = shorts.length ? shorts.reduce((a,s) => a + (s.eng?.rr||0), 0) / shorts.length : 0;
  const avgSkew = results.length ? results.reduce((a,s) => a + (s.eng?.skew||0), 0) / results.length : 0;
  let regime = 'NEUTRAL';
  if (avgLongRR > 10) regime = 'BULLISH';
  if (avgLongRR > 20) regime = 'STRONG BULL';
  if (avgLongRR < -5) regime = 'BEARISH';
  if (avgLongRR < -15) regime = 'STRONG BEAR';
  return { results, longs: longs.length, shorts: shorts.length, avgLongRR, avgShortRR, avgSkew, regime };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MICRO COMPONENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Badge({children,color,small,style:sx}){return<span style={{display:'inline-flex',alignItems:'center',padding:small?'1px 6px':'2px 8px',borderRadius:3,fontSize:small?9:10,fontWeight:700,fontFamily:'var(--mono)',letterSpacing:'.04em',background:`${color}15`,color,border:`1px solid ${color}35`,...sx}}>{children}</span>}
function Btn({children,onClick,active,color,style:sx,...p}){const c=color||'var(--fg3)';return<button onClick={onClick} style={{padding:'6px 12px',borderRadius:4,cursor:'pointer',fontSize:11,fontFamily:'var(--mono)',fontWeight:600,transition:'all .15s',border:`1px solid ${active?c+'60':'var(--border)'}`,background:active?c+'12':'transparent',color:active?c:'var(--fg4)',...sx}} {...p}>{children}</button>}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Header({view, setView}) {
  const navItems = [
    {id:'overview', label:'Overview', icon:'‚óâ'},
    {id:'macro', label:'Macro', icon:'‚ö°'},
    {id:'operators', label:'Operators', icon:'‚óÜ'},
    {id:'data', label:'Data', icon:'‚¨Ü'},
    {id:'export', label:'Export', icon:'‚Üì'},
  ];
  return <div style={{background:'var(--bg1)',borderBottom:'1px solid var(--border2)',padding:'0 28px',display:'flex',alignItems:'center',gap:0,height:52,flexShrink:0}}>
    <div style={{display:'flex',alignItems:'center',gap:10,marginRight:40}}>
      <div style={{width:8,height:8,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 8px var(--g)',animation:'pulse 2s infinite'}}/>
      <span style={{fontSize:20,fontFamily:'var(--mono)',fontWeight:700,color:'var(--fg)',letterSpacing:'-.02em'}}>XA</span>
      <span style={{fontSize:10,color:'var(--fg4)',fontFamily:'var(--mono)',letterSpacing:'.05em'}}>powered by Upside</span>
    </div>
    <div style={{display:'flex',gap:2}}>
      {navItems.map(n => <button key={n.id} onClick={() => setView(n.id)} style={{
        padding:'14px 16px',fontSize:11,fontFamily:'var(--mono)',fontWeight:600,cursor:'pointer',
        border:'none',background:'transparent',color:view===n.id?'var(--fg)':'var(--fg4)',
        borderBottom:view===n.id?'2px solid var(--g)':'2px solid transparent',transition:'all .15s'
      }}>{n.icon} {n.label}</button>)}
    </div>
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function OverviewView({operators, masterMacros, setView}) {
  const allStats = operators.map(op => ({...op, stats: computeOpStats(op, masterMacros)}));
  const totalNames = allStats.reduce((a,o) => a + o.stocks.length, 0);
  const totalLongs = allStats.reduce((a,o) => a + o.stats.longs, 0);
  const totalShorts = allStats.reduce((a,o) => a + o.stats.shorts, 0);
  const bullOps = allStats.filter(o => o.stats.avgLongRR > 8).length;
  const categories = ['GRS','Asian GRS'];

  return <div style={{padding:32,maxWidth:1200,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:32}}>
      <h1 style={{fontSize:32,fontFamily:'var(--serif)',color:'var(--fg)',fontWeight:400,marginBottom:6}}>Command Centre</h1>
      <p style={{fontSize:13,color:'var(--fg3)'}}>GRS ¬∑ Asian GRS ‚Äî {operators.length} operators ¬∑ {totalNames} stocks ¬∑ {masterMacros.length} macro drivers</p>
    </div>
    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:12,marginBottom:32}}>
      {[
        ['Operators', operators.length, 'var(--fg)'],
        ['Total Names', totalNames, 'var(--b)'],
        ['Longs', totalLongs, 'var(--g)'],
        ['Shorts', totalShorts, 'var(--r)'],
        ['Macro Drivers', masterMacros.length, 'var(--y)'],
        ['Bull Operators', bullOps+'/'+operators.length, 'var(--g2)'],
      ].map(([l,v,c]) => <div key={l} style={{padding:'16px 18px',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:6}}>
        <div style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>{l}</div>
        <div style={{fontSize:22,fontFamily:'var(--mono)',fontWeight:700,color:c}}>{v}</div>
      </div>)}
    </div>
    {categories.map(cat => {
      const catOps = allStats.filter(o => o.category === cat);
      if (!catOps.length) return null;
      return <div key={cat} style={{marginBottom:28}}>
        <div style={{fontSize:10,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.12em',marginBottom:12,display:'flex',alignItems:'center',gap:8}}>
          <span>{cat}</span>
          <span style={{flex:1,height:1,background:'var(--border)'}}/>
          <span>{catOps.length} operators ¬∑ {catOps.reduce((a,o)=>a+o.stocks.length,0)} stocks</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(340px,1fr))',gap:14}}>
          {catOps.map(op => {
            const s = op.stats;
            const regimeColor = s.regime.includes('BULL') ? 'var(--g)' : s.regime.includes('BEAR') ? 'var(--r)' : 'var(--fg3)';
            return <div key={op.id} style={{background:'var(--bg2)',border:`1px solid ${op.color}20`,borderRadius:8,overflow:'hidden'}}>
              <div style={{padding:'16px 20px',borderBottom:'1px solid var(--border)'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
                  <div style={{display:'flex',alignItems:'center',gap:10}}>
                    <span style={{fontSize:20}}>{op.icon}</span>
                    <div>
                      <span style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
                      <span style={{fontSize:11,color:'var(--fg4)',marginLeft:8}}>{op.team}</span>
                    </div>
                  </div>
                  <Badge color={regimeColor} small>{s.regime}</Badge>
                </div>
                <div style={{fontSize:11,color:'var(--fg3)',marginBottom:4}}>{op.desc}</div>
              </div>
              <div style={{padding:'12px 20px',display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Names</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{op.stocks.length}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>L / S</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600}}><span style={{color:'var(--g)'}}>{s.longs}</span><span style={{color:'var(--fg4)'}}> / </span><span style={{color:'var(--r)'}}>{s.shorts}</span></div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg R/R</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:s.avgLongRR>0?'var(--g)':'var(--r)'}}>{fmt(s.avgLongRR,'pct')}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg Skew</div><div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:600,color:s.avgSkew>1?'var(--g)':'var(--fg3)'}}>{fmt(s.avgSkew,'ratio')}</div></div>
              </div>
              <div style={{padding:'8px 20px 14px'}}>
                <div onClick={() => setView('operators')} style={{display:'block',textAlign:'center',padding:'8px',fontSize:11,fontFamily:'var(--mono)',fontWeight:700,borderRadius:4,cursor:'pointer',border:`1px solid ${op.color}40`,background:`${op.color}08`,color:op.color,transition:'all .15s'}}>
                  Open {op.name} Engine ‚Üí
                </div>
              </div>
            </div>;
          })}
        </div>
      </div>;
    })}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MACRO DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function MacroView({operators, masterMacros, setMasterMacros, opToggles, setOpToggles}) {
  const [subTab, setSubTab] = useState('master'); /* 'master' or 'mapping' */
  const [selOp, setSelOp] = useState(operators[0]?.id || '');

  const updateSignal = (macroId, val) => {
    setMasterMacros(p => p.map(m => m.id === macroId ? {...m, signal: val} : m));
  };

  const toggleOpMacro = (opId, macroId) => {
    setOpToggles(p => {
      const key = `${opId}__${macroId}`;
      return {...p, [key]: p[key] === false ? true : (p[key] === true ? false : false)};
    });
  };

  const isActive = (opId, macroId) => {
    const key = `${opId}__${macroId}`;
    return opToggles[key] !== false;
  };

  const bullCount = masterMacros.filter(d => d.signal > 0.3).length;
  const bearCount = masterMacros.filter(d => d.signal < -0.3).length;
  const neutralCount = masterMacros.length - bullCount - bearCount;

  return <div style={{padding:32,maxWidth:1100,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:20}}>
      <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--y)',fontWeight:400,marginBottom:6}}>Macro Dashboard</h1>
      <p style={{fontSize:12,color:'var(--fg4)'}}>Set global macro conditions, then map them to operators with per-operator toggles.</p>
    </div>

    <div style={{display:'flex',gap:6,marginBottom:20}}>
      <Btn active={subTab==='master'} color="var(--y)" onClick={() => setSubTab('master')}>‚ö° Master Conditions</Btn>
      <Btn active={subTab==='mapping'} color="var(--b)" onClick={() => setSubTab('mapping')}>üîó Operator Mapping</Btn>
      <span style={{marginLeft:'auto',display:'flex',gap:8,alignItems:'center'}}>
        <Badge color="var(--g)">{bullCount} Bull</Badge>
        <Badge color="var(--fg3)">{neutralCount} Neutral</Badge>
        <Badge color="var(--r)">{bearCount} Bear</Badge>
      </span>
    </div>

    {subTab === 'master' && <div>
      {MACRO_CATEGORIES.map(cat => {
        const catMacros = masterMacros.filter(m => m.category === cat);
        if (!catMacros.length) return null;
        const opsUsing = (macroId) => operators.filter(op => op.macroMap.some(m => m.macroId === macroId && isActive(op.id, macroId))).length;
        return <div key={cat} style={{marginBottom:20}}>
          <div style={{fontSize:9,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.12em',marginBottom:8,display:'flex',alignItems:'center',gap:8}}>
            <span>{cat}</span><span style={{flex:1,height:1,background:'var(--border)'}}/>
          </div>
          {catMacros.map(m => {
            const sc = m.signal > 0.3 ? 'var(--g)' : m.signal < -0.3 ? 'var(--r)' : 'var(--fg3)';
            const sl = m.signal > 0.5 ? 'STRONG BULL' : m.signal > 0.2 ? 'BULLISH' : m.signal > -0.2 ? 'NEUTRAL' : m.signal > -0.5 ? 'BEARISH' : 'STRONG BEAR';
            return <div key={m.id} style={{padding:'10px 16px',background:'var(--bg2)',borderRadius:6,marginBottom:4,display:'grid',gridTemplateColumns:'180px 1fr 60px 90px',gap:12,alignItems:'center'}}>
              <div>
                <div style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{m.label}</div>
                <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)'}}>{opsUsing(m.id)} operators</div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <span style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--r)',width:12,textAlign:'right'}}>-1</span>
                <input type="range" min="-100" max="100" value={Math.round(m.signal*100)} onChange={e => updateSignal(m.id, parseInt(e.target.value)/100)} style={{flex:1,accentColor:sc}}/>
                <span style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--g)',width:12}}>+1</span>
              </div>
              <div style={{textAlign:'right'}}>
                <span style={{fontSize:13,fontFamily:'var(--mono)',fontWeight:700,color:sc}}>{m.signal>0?'+':''}{m.signal.toFixed(2)}</span>
              </div>
              <div style={{textAlign:'right'}}>
                <span style={{fontSize:8,fontFamily:'var(--mono)',color:sc}}>{sl}</span>
              </div>
            </div>;
          })}
        </div>;
      })}
    </div>}

    {subTab === 'mapping' && <div>
      <div style={{display:'flex',gap:4,marginBottom:16,flexWrap:'wrap'}}>
        {operators.map(op => <Btn key={op.id} active={selOp===op.id} color={op.color} onClick={() => setSelOp(op.id)}>
          {op.icon} {op.name}
        </Btn>)}
      </div>
      {(() => {
        const op = operators.find(o => o.id === selOp);
        if (!op) return null;
        const activeMap = op.macroMap.filter(m => isActive(op.id, m.macroId));
        const totalW = activeMap.reduce((a,m) => a + m.weight, 0);
        const compositeSignal = activeMap.reduce((sum,m) => {
          const mm = masterMacros.find(g => g.id === m.macroId);
          return sum + ((mm?.signal||0) * m.weight / (totalW||1));
        }, 0);
        const compColor = compositeSignal > 0.15 ? 'var(--g)' : compositeSignal < -0.15 ? 'var(--r)' : 'var(--fg3)';

        /* All master macros not already in this operator's macroMap */
        const unmapped = masterMacros.filter(mm => !op.macroMap.some(m => m.macroId === mm.id));

        return <div style={{background:'var(--bg2)',borderRadius:8,border:`1px solid ${op.color}20`,overflow:'hidden'}}>
          <div style={{padding:'16px 20px',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <span style={{fontSize:22}}>{op.icon}</span>
              <div>
                <span style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
                <span style={{fontSize:11,color:'var(--fg4)',marginLeft:8}}>{op.category} ¬∑ {op.team}</span>
              </div>
            </div>
            <div style={{display:'flex',gap:12,alignItems:'center'}}>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--fg4)',textTransform:'uppercase'}}>Composite</div>
                <div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:700,color:compColor}}>{compositeSignal>0?'+':''}{compositeSignal.toFixed(3)}</div>
              </div>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--fg4)',textTransform:'uppercase'}}>Active Weight</div>
                <div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:700,color:totalW===100?'var(--g)':'var(--y)'}}>{totalW}%</div>
              </div>
            </div>
          </div>
          <div style={{padding:'12px 20px'}}>
            <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:8}}>Mapped Macros</div>
            {op.macroMap.map(m => {
              const mm = masterMacros.find(g => g.id === m.macroId);
              const active = isActive(op.id, m.macroId);
              const sc = (mm?.signal||0) > 0.3 ? 'var(--g)' : (mm?.signal||0) < -0.3 ? 'var(--r)' : 'var(--fg3)';
              return <div key={m.macroId} style={{display:'grid',gridTemplateColumns:'32px 170px 60px 1fr 80px',gap:10,alignItems:'center',padding:'8px 0',borderBottom:'1px solid var(--border)',opacity:active?1:0.35}}>
                <div style={{cursor:'pointer',fontSize:16,textAlign:'center'}} onClick={() => toggleOpMacro(op.id, m.macroId)} title={active?'Click to disable':'Click to enable'}>{active ? '‚úÖ' : '‚¨ú'}</div>
                <div style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{mm?.label || m.macroId}</div>
                <div style={{textAlign:'center'}}>
                  <Badge color={op.color} small>{m.weight}%</Badge>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:4}}>
                  <div style={{flex:1,height:6,background:'var(--bg)',borderRadius:3,overflow:'hidden'}}>
                    <div style={{width:`${Math.abs((mm?.signal||0))*100}%`,height:'100%',background:sc,borderRadius:3,marginLeft:(mm?.signal||0)<0?`${100-Math.abs((mm?.signal||0))*100}%`:0}}/>
                  </div>
                </div>
                <div style={{textAlign:'right',fontSize:12,fontFamily:'var(--mono)',fontWeight:700,color:sc}}>
                  {(mm?.signal||0)>0?'+':''}{(mm?.signal||0).toFixed(2)}
                </div>
              </div>;
            })}
            {unmapped.length > 0 && <div style={{marginTop:16}}>
              <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>Available (not mapped)</div>
              <div style={{display:'flex',flexWrap:'wrap',gap:4}}>
                {unmapped.map(mm => <span key={mm.id} style={{fontSize:9,fontFamily:'var(--mono)',padding:'2px 6px',borderRadius:3,background:'var(--bg)',color:'var(--fg4)',border:'1px solid var(--border)'}}>{mm.label}</span>)}
              </div>
            </div>}
          </div>
        </div>;
      })()}
    </div>}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPERATORS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Scenario bar */
function ScenarioBarPA({probs, prices, currentPrice}) {
  return <div style={{display:'flex',gap:1,height:26,borderRadius:4,overflow:'hidden'}}>
    {probs.map((p,i) => {
      const ret = ((prices[i]-currentPrice)/currentPrice*100);
      return <div key={i} style={{
        flex:p, background:SCENARIOS[i].color+'40', position:'relative',
        display:'flex',alignItems:'center',justifyContent:'center',
        borderRight:i<6?'1px solid var(--bg)':'none',
      }} title={`${SCENARIOS[i].label}: ${p.toFixed(1)}% ‚Üí ${fmt(prices[i],'price')} (${ret>=0?'+':''}${ret.toFixed(0)}%)`}>
        {p>7 && <span style={{fontSize:8,fontFamily:'var(--mono)',color:SCENARIOS[i].color,fontWeight:700}}>{p.toFixed(0)}%</span>}
      </div>;
    })}
  </div>;
}

/* GRS stock card with vertical bars */
function StockCardGRS({stock, eng, macroMap, masterMacros, open, toggle}) {
  const cp = stock.currentPrice;
  const mx = Math.max(...eng.pr);
  const isLong = stock.verdict === 'long';
  const vc = eng.vd.includes('LONG')?'var(--g)':eng.vd.includes('SHORT')?'var(--r)':'var(--fg3)';
  const tc = eng.tier==='Core'?'var(--y)':eng.tier==='Satellite'?'var(--b)':'var(--fg4)';
  const mdd = ((Math.min(...stock.prices)-cp)/cp*100);
  const mxu = ((Math.max(...stock.prices)-cp)/cp*100);
  const pt = getConvictionPT(stock, eng);

  return <div style={{background:'var(--bg1)',borderRadius:10,border:'1px solid var(--border)',borderLeft:`3px solid ${isLong?'var(--g)':'var(--r)'}`,overflow:'hidden',marginBottom:6}}>
    <div onClick={toggle} style={{padding:'12px 14px',cursor:'pointer',display:'flex',gap:12,alignItems:'center',flexWrap:'wrap'}}>
      <div style={{minWidth:110}}>
        <div style={{fontFamily:'var(--mono)',fontSize:13,fontWeight:700,color:'var(--fg)'}}>{stock.ticker}</div>
        <div style={{fontSize:11,color:'var(--fg3)',marginTop:1}}>{stock.name}</div>
      </div>
      <div style={{flex:1,minWidth:160}}>
        <div style={{display:'flex',alignItems:'flex-end',gap:2,height:50,marginBottom:3}}>
          {eng.pr.map((p,i) => <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}>
            <span style={{fontSize:7,fontFamily:'var(--mono)',color:'var(--fg3)',marginBottom:1}}>{p.toFixed(0)}%</span>
            <div style={{width:'100%',height:`${(p/mx)*38}px`,background:`linear-gradient(180deg, ${SCENARIOS[i].color}bb, ${SCENARIOS[i].color}33)`,borderRadius:'2px 2px 0 0',border:`1px solid ${SCENARIOS[i].color}55`}} />
          </div>)}
        </div>
        <div style={{display:'flex',gap:2}}>
          {stock.prices.map((s,i) => <div key={i} style={{flex:1,textAlign:'center',fontSize:7,fontFamily:'var(--mono)',color:SCENARIOS[i].color}}>{fmt(s,'price')}</div>)}
        </div>
      </div>
      <div style={{minWidth:115,textAlign:'right'}}>
        <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--fg3)'}}>Now: {fmt(cp,'price')}</div>
        <div style={{fontSize:15,fontFamily:'var(--mono)',fontWeight:700,color:'#6366f1'}}>EV: {fmt(eng.ev,'price')}</div>
        <div style={{fontSize:12,fontFamily:'var(--mono)',color:eng.rr>0?'var(--g)':'var(--r)',fontWeight:700}}>{fmt(eng.rr,'pct')}</div>
      </div>
      <div style={{minWidth:90,textAlign:'right'}}>
        <div style={{fontFamily:'var(--mono)',fontSize:11,fontWeight:700,color:vc}}>{eng.vd}</div>
        <div style={{fontFamily:'var(--mono)',fontSize:10,color:tc,marginTop:2}}>{eng.tier}</div>
        <div style={{fontFamily:'var(--mono)',fontSize:10,color:eng.skew>1?'#22d3ee':'#f97316',marginTop:2}}>Skew {eng.skew.toFixed(2)}</div>
      </div>
    </div>
    {open && <div style={{padding:'0 14px 14px',borderTop:'1px solid var(--border)'}}>
      <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:6,marginTop:12}}>
        {SCENARIOS.map((s,i) => <div key={s.id} style={{background:'var(--bg)',borderRadius:6,padding:8,textAlign:'center',border:`1px solid ${s.color}22`}}>
          <div style={{fontSize:8,fontFamily:'var(--mono)',color:s.color,fontWeight:600,marginBottom:3}}>{s.label}</div>
          <div style={{fontSize:13,fontFamily:'var(--mono)',color:'var(--fg)',fontWeight:700}}>{fmt(stock.prices[i],'price')}</div>
          <div style={{fontSize:10,fontFamily:'var(--mono)',color:s.color,marginTop:2}}>{eng.pr[i].toFixed(1)}%</div>
          <div style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--fg4)',marginTop:2}}>{(((stock.prices[i]-cp)/cp)*100).toFixed(0)}%</div>
        </div>)}
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,marginTop:12}}>
        <div style={{background:'var(--bg)',borderRadius:8,padding:10,border:'1px solid var(--border)'}}>
          <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg3)',letterSpacing:1,marginBottom:6}}>RISK</div>
          {[['Max Drawdown',`${mdd.toFixed(0)}%`,'var(--r)'],['Max Upside',`+${mxu.toFixed(0)}%`,'var(--g)'],['Skew',eng.skew.toFixed(2),eng.skew>1?'#22d3ee':'#f97316'],['Tier',eng.tier,tc]]
            .map(([k,va,co]) => <div key={k} style={{display:'flex',justifyContent:'space-between',fontSize:10,fontFamily:'var(--mono)',padding:'2px 0'}}>
              <span style={{color:'var(--fg3)'}}>{k}</span><span style={{color:co,fontWeight:600}}>{va}</span>
            </div>)}
        </div>
        <div style={{background:'var(--bg)',borderRadius:8,padding:10,border:'1px solid var(--border)'}}>
          <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg3)',letterSpacing:1,marginBottom:6}}>PRICE TARGETS</div>
          {[['Bull PT', fmt(pt.bullPT,'price'), 'var(--g)'],['Bear PT', fmt(pt.bearPT,'price'), 'var(--r)'],['Conviction', pt.conviction, vc],['Current', fmt(cp,'price'), 'var(--fg)']]
            .map(([k,va,co]) => <div key={k} style={{display:'flex',justifyContent:'space-between',fontSize:10,fontFamily:'var(--mono)',padding:'2px 0'}}>
              <span style={{color:'var(--fg3)'}}>{k}</span><span style={{color:co,fontWeight:600}}>{va}</span>
            </div>)}
        </div>
        <div style={{background:'var(--bg)',borderRadius:8,padding:10,border:'1px solid var(--border)'}}>
          <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg3)',letterSpacing:1,marginBottom:6}}>MACRO SENSITIVITY</div>
          <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
            {macroMap.map(m => {
              const sv = stock.sens?.[m.macroId] || 0;
              const mm = masterMacros.find(d => d.id === m.macroId);
              return <div key={m.macroId} style={{background:'var(--bg1)',borderRadius:4,padding:'3px 7px',border:'1px solid var(--border)',fontSize:10,fontFamily:'var(--mono)'}}>
                <span style={{color:'var(--fg4)'}}>{(mm?.label||m.macroId).split(' ')[0]}: </span>
                <span style={{color:sv>0?'var(--g)':sv<0?'var(--r)':'var(--fg4)',fontWeight:600}}>{sv>0?'+':''}{sv.toFixed(1)}</span>
              </div>;
            })}
          </div>
        </div>
      </div>
    </div>}
  </div>;
}

/* Main Operators View */
function OperatorsView({operators, masterMacros}) {
  const [selectedOp, setSelectedOp] = useState(null);
  const [sortBy, setSortBy] = useState('rr');
  const [openCards, setOpenCards] = useState({});
  const allStats = operators.map(op => ({...op, stats: computeOpStats(op, masterMacros)}));
  const toggleCard = (ticker) => setOpenCards(prev => ({...prev, [ticker]: !prev[ticker]}));
  const categories = ['GRS','Asian GRS'];

  if (!selectedOp) {
    return <div style={{padding:32,maxWidth:1200,margin:'0 auto',animation:'fadeIn .3s ease'}}>
      <div style={{marginBottom:28}}>
        <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--p)',fontWeight:400,marginBottom:6}}>Operators</h1>
        <p style={{fontSize:12,color:'var(--fg4)'}}>Click any operator to open its engine with stock detail, scenario bars, and price targets.</p>
      </div>
      {categories.map(cat => {
        const catOps = allStats.filter(o => o.category === cat);
        if (!catOps.length) return null;
        return <div key={cat} style={{marginBottom:24}}>
          <div style={{fontSize:10,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.12em',marginBottom:10,display:'flex',alignItems:'center',gap:8}}>
            <span>{cat}</span><span style={{flex:1,height:1,background:'var(--border)'}}/>
          </div>
          {catOps.map(op => {
            const s = op.stats;
            const topLongs = s.results.filter(r => r.verdict==='long').sort((a,b) => (b.eng?.rr||0)-(a.eng?.rr||0)).slice(0,3);
            const topShorts = s.results.filter(r => r.verdict==='short').sort((a,b) => (a.eng?.rr||0)-(b.eng?.rr||0)).slice(0,3);
            return <div key={op.id} onClick={() => setSelectedOp(op.id)} style={{marginBottom:14,background:'var(--bg2)',border:`1px solid ${op.color}15`,borderRadius:8,overflow:'hidden',cursor:'pointer',transition:'border-color .15s'}}
              onMouseEnter={e => e.currentTarget.style.borderColor = op.color+'60'}
              onMouseLeave={e => e.currentTarget.style.borderColor = op.color+'15'}>
              <div style={{padding:'18px 24px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                <div style={{display:'flex',alignItems:'center',gap:12}}>
                  <span style={{fontSize:24}}>{op.icon}</span>
                  <div>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <span style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
                      <Badge color={op.color} small>{op.category}</Badge>
                      <span style={{fontSize:12,color:'var(--fg3)'}}>{op.team}</span>
                    </div>
                    <div style={{fontSize:11,color:'var(--fg4)',marginTop:2}}>{op.desc}</div>
                  </div>
                </div>
                <span style={{fontSize:11,fontFamily:'var(--mono)',color:op.color}}>View Detail ‚Üí</span>
              </div>
              <div style={{padding:'14px 24px',display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:12}}>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Names</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--fg)'}}>{op.stocks.length}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Long R/R</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--g)'}}>{fmt(s.avgLongRR,'pct')}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Short R/R</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:'var(--r)'}}>{fmt(s.avgShortRR,'pct')}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg Skew</div><div style={{fontSize:16,fontFamily:'var(--mono)',fontWeight:600,color:s.avgSkew>1?'var(--g)':'var(--fg3)'}}>{fmt(s.avgSkew,'ratio')}</div></div>
                <div><div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Regime</div><div style={{fontSize:12,fontFamily:'var(--mono)',fontWeight:600,color:s.regime.includes('BULL')?'var(--g)':s.regime.includes('BEAR')?'var(--r)':'var(--fg3)'}}>{s.regime}</div></div>
              </div>
              <div style={{padding:'0 24px 16px',display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
                <div>
                  <div style={{fontSize:8,color:'var(--g)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>Top Longs</div>
                  {topLongs.map(s => <div key={s.ticker} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'4px 0',fontSize:11,fontFamily:'var(--mono)'}}>
                    <span style={{color:'var(--fg)',fontWeight:600}}>{s.ticker}</span>
                    <span style={{color:'var(--fg3)'}}>{s.name}</span>
                    <span style={{color:'var(--g)',fontWeight:700}}>{fmt(s.eng?.rr,'pct')}</span>
                  </div>)}
                </div>
                <div>
                  <div style={{fontSize:8,color:'var(--r)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:6}}>Top Shorts</div>
                  {topShorts.map(s => <div key={s.ticker} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'4px 0',fontSize:11,fontFamily:'var(--mono)'}}>
                    <span style={{color:'var(--fg)',fontWeight:600}}>{s.ticker}</span>
                    <span style={{color:'var(--fg3)'}}>{s.name}</span>
                    <span style={{color:'var(--r)',fontWeight:700}}>{fmt(s.eng?.rr,'pct')}</span>
                  </div>)}
                </div>
              </div>
            </div>;
          })}
        </div>;
      })}
    </div>;
  }

  /* OPERATOR DETAIL VIEW */
  const op = allStats.find(o => o.id === selectedOp);
  if (!op) return null;
  const s = op.stats;
  const results = [...s.results];
  if (sortBy === 'rr') results.sort((a,b) => Math.abs(b.eng?.rr||0) - Math.abs(a.eng?.rr||0));
  if (sortBy === 'skew') results.sort((a,b) => (b.eng?.skew||0) - (a.eng?.skew||0));
  if (sortBy === 'alpha') results.sort((a,b) => a.ticker.localeCompare(b.ticker));
  if (sortBy === 'side') results.sort((a,b) => (a.verdict==='long'?0:1) - (b.verdict==='long'?0:1));

  const compositeSignal = masterMacros.reduce((sum,mm) => {
    const dm = op.macroMap.find(m => m.macroId === mm.id);
    return sum + (mm.signal * (dm ? dm.weight : 0) / 100);
  }, 0);
  let regime = 'NEUTRAL';
  if (compositeSignal > 0.15) regime = 'BULLISH';
  if (compositeSignal > 0.35) regime = 'STRONG BULL';
  if (compositeSignal < -0.15) regime = 'BEARISH';
  if (compositeSignal < -0.35) regime = 'STRONG BEAR';
  const regimeColor = regime.includes('BULL') ? 'var(--g)' : regime.includes('BEAR') ? 'var(--r)' : 'var(--fg3)';

  return <div style={{padding:32,maxWidth:1200,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:24}}>
      <button onClick={() => setSelectedOp(null)} style={{border:'none',background:'transparent',color:'var(--fg4)',fontFamily:'var(--mono)',fontSize:12,cursor:'pointer',padding:'4px 0',marginBottom:8}}>‚Üê All Operators</button>
      <div style={{display:'flex',alignItems:'center',gap:14}}>
        <span style={{fontSize:32}}>{op.icon}</span>
        <div>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <span style={{fontSize:26,fontFamily:'var(--mono)',fontWeight:700,color:op.color}}>{op.name}</span>
            <Badge color={op.color}>{op.category}</Badge>
            <span style={{fontSize:14,color:'var(--fg3)'}}>{op.team}</span>
          </div>
          <div style={{fontSize:12,color:'var(--fg4)',marginTop:2}}>{op.desc}</div>
        </div>
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:20}}>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Composite</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:regimeColor}}>{compositeSignal>0?'+':''}{compositeSignal.toFixed(3)}</div>
      </div>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Regime</div>
        <div style={{fontSize:14,fontFamily:'var(--mono)',fontWeight:700,color:regimeColor}}>{regime}</div>
      </div>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Long R/R</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:'var(--g)'}}>{fmt(s.avgLongRR,'pct')}</div>
      </div>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Short R/R</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:'var(--r)'}}>{fmt(s.avgShortRR,'pct')}</div>
      </div>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Avg Skew</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:s.avgSkew>1?'var(--g)':'var(--fg3)'}}>{fmt(s.avgSkew,'ratio')}</div>
      </div>
      <div style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase'}}>Names</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700}}><span style={{color:'var(--g)'}}>{s.longs}</span><span style={{color:'var(--fg4)'}}> / </span><span style={{color:'var(--r)'}}>{s.shorts}</span></div>
      </div>
    </div>

    <div style={{display:'flex',gap:4,marginBottom:14}}>
      {[['rr','R/R'],['skew','Skew'],['alpha','A‚ÜíZ'],['side','Side']].map(([k,l]) =>
        <Btn key={k} active={sortBy===k} color={op.color} onClick={() => setSortBy(k)}>{l}</Btn>)}
    </div>

    {results.map((r,i) => <StockCardGRS key={r.ticker} stock={r} eng={r.eng} macroMap={op.macroMap} masterMacros={masterMacros} open={openCards[r.ticker]} toggle={() => toggleCard(r.ticker)} />)}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function DataView({operators, masterMacros, snapData, setSnapData}) {
  const [dragOver, setDragOver] = useState(false);
  const [parsing, setParsing] = useState(false);
  const [error, setError] = useState(null);
  const fileRef = useRef(null);
  const [opFilter, setOpFilter] = useState('all');
  const [searchQ, setSearchQ] = useState('');
  const [sortCol, setSortCol] = useState('mkt_cap_usd_m');
  const [sortDir, setSortDir] = useState('desc');

  const parseFile = (file) => {
    setError(null); setParsing(true);
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets['Upload'] || wb.Sheets[wb.SheetNames[0]];
        if (!ws) throw new Error('No "Upload" sheet found');
        const raw = XLSX.utils.sheet_to_json(ws, {defval:''});
        if (!raw.length) throw new Error('Sheet is empty');

        const parsed = raw.map(r => {
          const bbg = (r['BBG Ticker'] || r['bbg_ticker'] || r['Ticker'] || '').toString().trim();
          const name = (r['Name'] || r['name'] || r['Security Name'] || '').toString().trim();
          const price = parseFloat(r['Price'] || r['price'] || r['PX_LAST'] || 0);
          const mktCap = parseFloat(r['Mkt Cap (USD m)'] || r['mkt_cap_usd_m'] || r['CUR_MKT_CAP'] || 0);
          const country = (r['Country'] || r['country'] || r['COUNTRY_ISO'] || '').toString().trim();
          const sector = (r['Sector'] || r['sector'] || r['GICS_SECTOR_NAME'] || '').toString().trim();
          const pe = parseFloat(r['PE'] || r['pe'] || r['PE_RATIO'] || 0) || null;
          const div_yield = parseFloat(r['Div Yield'] || r['div_yield'] || r['EQY_DVD_YLD_IND'] || 0) || null;
          return { bbg_ticker: bbg, name, price, mkt_cap_usd_m: mktCap, country, sector, pe, div_yield };
        }).filter(r => r.bbg_ticker && r.price > 0);

        const filtered = parsed.filter(r => r.mkt_cap_usd_m >= 1000);

        const allOpStocks = operators.flatMap(op => op.stocks.map(s => ({...s, opId: op.id, opName: op.name})));
        const tickerSet = new Set(allOpStocks.map(s => s.ticker));

        let priceUpdates = 0;
        const priceMap = {};
        parsed.forEach(r => {
          const bbgClean = r.bbg_ticker.replace(/\s+Equity$/i, '').trim();
          const localTicker = bbgClean.replace(/\s+/g, '.');
          const alts = [localTicker, bbgClean, bbgClean.split(' ')[0]];
          for (const alt of alts) {
            if (tickerSet.has(alt)) { priceMap[alt] = r.price; priceUpdates++; break; }
          }
        });

        parsed.forEach(r => {
          const bbgClean = r.bbg_ticker.replace(/\s+Equity$/i, '').trim();
          const localTicker = bbgClean.replace(/\s+/g, '.');
          const matchedOps = [];
          operators.forEach(op => {
            if (op.stocks.some(s => s.ticker === localTicker || s.ticker === bbgClean || s.ticker === bbgClean.split(' ')[0])) {
              matchedOps.push(op.id);
            }
          });
          r.matched_ops = matchedOps;
          r.is_direct_match = matchedOps.length > 0;
        });

        const unmatched = allOpStocks.filter(s => !priceMap[s.ticker]).map(s => ({ticker: s.ticker, name: s.name, opName: s.opName}));

        window.XA_PRICES = priceMap;
        let patchCount = 0;
        OPERATORS.forEach(op => {
          op.stocks.forEach(s => {
            if (priceMap[s.ticker] != null) { s.currentPrice = priceMap[s.ticker]; patchCount++; }
          });
        });
        console.log(`[XA Data Hub] Patched ${patchCount} prices. Matches: ${priceUpdates}/${allOpStocks.length}`);

        const snapDate = new Date().toISOString().slice(0,10);
        const newSnap = { date: snapDate, fileName: file.name, totalParsed: parsed.length, totalFiltered: filtered.length, priceUpdates, priceMap, unmatched, universe: filtered };
        setSnapData(newSnap);

        try { localStorage.setItem('xa_prices', JSON.stringify(priceMap)); } catch(e) {}
        try { LS.set('xa_snap_v3', newSnap); } catch(e) {
          try { LS.set('xa_snap_v3', {...newSnap, universe: []}); } catch(e2) {
            try { LS.set('xa_snap_v3', {date: snapDate, priceMap, priceUpdates}); } catch(e3) {}
          }
        }

        /* Auto-download api.json */
        try {
          const apiOps = operators.map(op => {
            const results = op.stocks.map(s => {
              const eng = runEngine(s, op.macroMap, masterMacros);
              const pt = getConvictionPT(s, eng);
              return { ticker:s.ticker, name:s.name, side:s.verdict, currentPrice:s.currentPrice,
                bull_pt:pt.bullPT, bear_pt:pt.bearPT, conviction:pt.conviction,
                ev:eng?.ev?+eng.ev.toFixed(2):null, rr_pct:eng?.rr?+eng.rr.toFixed(2):null,
                skew:eng?.skew?+eng.skew.toFixed(3):null, verdict:eng?.vd||null, tier:eng?.tier||null,
                probabilities:eng?.pr?.map(p=>+p.toFixed(2))||[], sensitivity:s.sens||{} };
            });
            const macroSignals = op.macroMap.map(m => {
              const mm = masterMacros.find(d => d.id === m.macroId);
              return { id:m.macroId, label:mm?.label||m.macroId, weight:m.weight, signal:mm?.signal??0 };
            });
            return { id:op.id, name:op.name, category:op.category, team:op.team, color:op.color, desc:op.desc, drivers:macroSignals, stocks:results };
          });
          download(JSON.stringify({version:'4.0',generated:new Date().toISOString(),snapDate,operators:apiOps},null,2),'api.json','application/json');
          console.log('[XA Data Hub] api.json downloaded');
        } catch(apiErr) { console.warn('[XA Data Hub] api.json failed:', apiErr.message); }

        setParsing(false);
        console.log('[XA Data Hub] Reloading...');
        setTimeout(() => window.location.reload(), 500);
      } catch(err) { setError('Parse error: ' + err.message); setParsing(false); }
    };
    reader.readAsArrayBuffer(file);
  };

  const handleDrop = (e) => { e.preventDefault(); setDragOver(false); if (e.dataTransfer.files[0]) parseFile(e.dataTransfer.files[0]); };
  const handleDragOver = (e) => { e.preventDefault(); setDragOver(true); };
  const handleDragLeave = () => setDragOver(false);
  const handleClick = () => fileRef.current?.click();
  const handleFileInput = (e) => { if (e.target.files[0]) parseFile(e.target.files[0]); };
  const clearSnap = () => { if(confirm('Clear universe data?')){ window.XA_PRICES={}; setSnapData(null); localStorage.removeItem('xa_snap_v3'); localStorage.removeItem('xa_prices'); }};

  const opCoverage = useMemo(() => {
    if (!snapData?.universe) return {};
    const cov = {};
    operators.forEach(op => { cov[op.id] = { total: 0, matched: 0 }; });
    snapData.universe.forEach(r => {
      (r.matched_ops||[]).forEach(opId => {
        if (cov[opId]) { cov[opId].total++; if (r.is_direct_match) cov[opId].matched++; }
      });
    });
    return cov;
  }, [snapData, operators]);

  const displayData = useMemo(() => {
    if (!snapData?.universe) return [];
    let d = [...snapData.universe];
    if (opFilter !== 'all') d = d.filter(r => (r.matched_ops||[]).includes(opFilter));
    if (searchQ) { const q = searchQ.toLowerCase(); d = d.filter(r => r.name.toLowerCase().includes(q) || r.bbg_ticker.toLowerCase().includes(q)); }
    d.sort((a,b) => {
      const av = a[sortCol]||0, bv = b[sortCol]||0;
      if (typeof av === 'string') return sortDir==='asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      return sortDir==='asc' ? av-bv : bv-av;
    });
    return d.slice(0, 200);
  }, [snapData, opFilter, searchQ, sortCol, sortDir]);

  const toggleSort = (col) => { if (sortCol===col) setSortDir(sortDir==='asc'?'desc':'asc'); else { setSortCol(col); setSortDir('desc'); } };
  const fmtV = (v, dp=1) => v ? (typeof v === 'number' ? v.toFixed(dp) : v) : '‚Äî';
  const fmtK = (v) => v >= 1e6 ? (v/1e6).toFixed(0)+'T' : v >= 1e3 ? (v/1e3).toFixed(0)+'B' : v ? v.toFixed(0)+'M' : '‚Äî';

  return <div style={{padding:32,maxWidth:1400,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--y)',fontWeight:400,marginBottom:6}}>Data Hub</h1>
    <p style={{fontSize:12,color:'var(--fg4)',marginBottom:28}}>Bloomberg universe upload ¬∑ Friday COB snap ¬∑ Operator screening</p>

    <div onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onClick={handleClick}
      style={{border:`2px dashed ${dragOver?'var(--g)':'var(--border2)'}`,borderRadius:8,padding:40,textAlign:'center',cursor:'pointer',background:dragOver?'rgba(0,230,118,.04)':'var(--bg1)',transition:'all .2s',marginBottom:24}}>
      <input ref={fileRef} type="file" accept=".xlsx,.xls,.csv" onChange={handleFileInput} style={{display:'none'}}/>
      {parsing ? <div style={{color:'var(--y)',fontFamily:'var(--mono)',fontSize:13}}>‚è≥ Parsing...</div> :
        <div><div style={{fontSize:28,marginBottom:8}}>{dragOver?'üì•':'üìä'}</div>
          <div style={{fontSize:13,color:'var(--fg)',fontFamily:'var(--mono)',marginBottom:4}}>Drop xa_universe_YYYYMMDD.xlsx here</div>
          <div style={{fontSize:11,color:'var(--fg4)'}}>or click to browse</div></div>}
    </div>
    {error && <div style={{padding:'10px 16px',background:'rgba(255,61,113,.1)',border:'1px solid rgba(255,61,113,.3)',borderRadius:6,color:'var(--r)',fontSize:12,fontFamily:'var(--mono)',marginBottom:16}}>{error}</div>}

    {snapData && <div style={{background:'var(--bg1)',border:'1px solid var(--border2)',borderRadius:8,padding:20,marginBottom:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:8,height:8,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 8px var(--g)'}}/>
          <span style={{fontSize:13,fontFamily:'var(--mono)',fontWeight:700,color:'var(--fg)'}}>Universe Loaded</span>
        </div>
        <button onClick={clearSnap} style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',background:'transparent',border:'1px solid var(--border)',borderRadius:3,padding:'3px 8px',cursor:'pointer'}}>Clear</button>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:12,marginBottom:20}}>
        {[['File',snapData.fileName,'var(--fg3)'],['Names',snapData.totalFiltered?.toLocaleString()+' (>$1bn)','var(--b)'],['Raw',snapData.totalParsed?.toLocaleString(),'var(--fg3)'],['Matches',snapData.priceUpdates+' / '+operators.reduce((a,o)=>a+o.stocks.length,0),'var(--g)'],['Date',snapData.date,'var(--y)']].map(([l,v,c],i) =>
          <div key={i} style={{background:'var(--bg2)',borderRadius:6,padding:'12px 14px'}}>
            <div style={{fontSize:9,fontWeight:700,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:4}}>{l}</div>
            <div style={{fontSize:14,fontWeight:600,color:c,fontFamily:'var(--mono)'}}>{v}</div>
          </div>)}
      </div>
      <div style={{fontSize:10,fontWeight:700,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:10}}>Operator Coverage</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(180px,1fr))',gap:8}}>
        {operators.map(op => {
          const cov = opCoverage[op.id]||{total:0,matched:0};
          return <div key={op.id} style={{background:'var(--bg2)',borderRadius:6,padding:'10px 12px',borderLeft:`3px solid ${op.color}`}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
              <span style={{fontSize:11,fontWeight:700,color:op.color,fontFamily:'var(--mono)'}}>{op.icon} {op.name}</span>
              <span style={{fontSize:10,color:'var(--fg3)',fontFamily:'var(--mono)'}}>{cov.total}</span>
            </div>
          </div>;
        })}
      </div>
    </div>}

    {snapData && <div style={{background:'var(--bg1)',border:'1px solid rgba(99,102,241,.2)',borderRadius:8,padding:16,marginBottom:24}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
        <span style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:700,color:'#6366f1'}}>‚ö° XA-Coach API</span>
        <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)'}}>api.json auto-downloaded on snap upload</span>
      </div>
      <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--fg3)',marginBottom:6}}>
        Endpoint: <span style={{color:'var(--b)',userSelect:'all'}}>https://willhp-up.github.io/Upside-XA/api.json</span>
      </div>
      <div style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)'}}>
        Drop api.json into your local repo folder, then <code style={{color:'var(--fg3)'}}>git add api.json; git push</code> to publish.
      </div>
      <button onClick={() => {
        try {
          const apiOps = operators.map(op => {
            const results = op.stocks.map(s => {
              const eng = runEngine(s, op.macroMap, masterMacros);
              const pt = getConvictionPT(s, eng);
              return { ticker:s.ticker, name:s.name, side:s.verdict, currentPrice:s.currentPrice,
                bull_pt:pt.bullPT, bear_pt:pt.bearPT, conviction:pt.conviction,
                ev:eng?.ev?+eng.ev.toFixed(2):null, rr_pct:eng?.rr?+eng.rr.toFixed(2):null,
                skew:eng?.skew?+eng.skew.toFixed(3):null, verdict:eng?.vd||null, tier:eng?.tier||null };
            });
            const macroSignals = op.macroMap.map(m => {
              const mm = masterMacros.find(d => d.id === m.macroId);
              return { id:m.macroId, label:mm?.label||m.macroId, weight:m.weight, signal:mm?.signal??0 };
            });
            return { id:op.id, name:op.name, category:op.category, team:op.team, stocks:results, drivers:macroSignals };
          });
          download(JSON.stringify({version:'4.0',generated:new Date().toISOString(),snapDate:snapData.date,operators:apiOps},null,2),'api.json','application/json');
        } catch(e) { console.warn('api.json re-gen failed:', e); }
      }} style={{marginTop:8,fontSize:10,fontFamily:'var(--mono)',padding:'4px 12px',borderRadius:4,cursor:'pointer',border:'1px solid rgba(99,102,241,.3)',background:'rgba(99,102,241,.08)',color:'#6366f1'}}>
        ‚Üì Re-download api.json
      </button>
    </div>}

    {snapData?.unmatched?.length > 0 && <div style={{background:'var(--bg1)',border:'1px solid rgba(255,61,113,.2)',borderRadius:8,padding:16,marginBottom:24}}>
      <span style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:700,color:'var(--r)'}}>‚ö† Unmatched ({snapData.unmatched.length})</span>
      <div style={{display:'flex',flexWrap:'wrap',gap:4,marginTop:8}}>
        {snapData.unmatched.map((s,i) => <span key={i} style={{fontSize:9,fontFamily:'var(--mono)',padding:'2px 6px',borderRadius:3,background:'rgba(255,61,113,.08)',color:'var(--r)',border:'1px solid rgba(255,61,113,.15)'}} title={s.opName+': '+s.name}>{s.ticker}</span>)}
      </div>
    </div>}

    {displayData.length > 0 && <div style={{marginTop:16}}>
      <div style={{display:'flex',gap:8,marginBottom:12,alignItems:'center'}}>
        <select value={opFilter} onChange={e => setOpFilter(e.target.value)} style={{padding:'6px 10px',fontSize:11,fontFamily:'var(--mono)',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:4,color:'var(--fg)'}}>
          <option value="all">All Operators</option>
          {operators.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
        </select>
        <input value={searchQ} onChange={e => setSearchQ(e.target.value)} placeholder="Search..." style={{padding:'6px 10px',fontSize:11,fontFamily:'var(--mono)',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:4,color:'var(--fg)',flex:1,maxWidth:250}}/>
        <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)'}}>{displayData.length} shown</span>
      </div>
      <div style={{overflowX:'auto',borderRadius:6,border:'1px solid var(--border)'}}>
        <table style={{width:'100%',borderCollapse:'collapse',fontSize:11,fontFamily:'var(--mono)'}}>
          <thead><tr style={{background:'var(--bg2)'}}>
            {[['bbg_ticker','Ticker'],['name','Name'],['price','Price'],['mkt_cap_usd_m','Mkt Cap'],['country','Country'],['sector','Sector'],['pe','PE']].map(([k,l]) =>
              <th key={k} onClick={() => toggleSort(k)} style={{padding:'8px 10px',textAlign:'left',cursor:'pointer',color:'var(--fg3)',fontSize:9,textTransform:'uppercase',letterSpacing:'.05em',borderBottom:'1px solid var(--border)',whiteSpace:'nowrap'}}>{l} {sortCol===k?(sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>)}
          </tr></thead>
          <tbody>{displayData.map((r,i) => <tr key={i} style={{borderBottom:'1px solid var(--border)',background:r.is_direct_match?'rgba(0,230,118,.03)':'transparent'}}>
            <td style={{padding:'6px 10px',color:r.is_direct_match?'var(--g)':'var(--fg)',fontWeight:r.is_direct_match?700:400}}>{r.bbg_ticker}</td>
            <td style={{padding:'6px 10px',color:'var(--fg3)'}}>{r.name}</td>
            <td style={{padding:'6px 10px',color:'var(--fg)'}}>{fmtV(r.price,2)}</td>
            <td style={{padding:'6px 10px',color:'var(--b)'}}>{fmtK(r.mkt_cap_usd_m)}</td>
            <td style={{padding:'6px 10px',color:'var(--fg4)'}}>{r.country}</td>
            <td style={{padding:'6px 10px',color:'var(--fg4)'}}>{r.sector}</td>
            <td style={{padding:'6px 10px',color:'var(--fg3)'}}>{fmtV(r.pe)}</td>
          </tr>)}</tbody>
        </table>
      </div>
    </div>}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function ExportView({operators, masterMacros, opToggles}) {
  const [scope, setScope] = useState('all');
  const [catFilter, setCatFilter] = useState('all');
  const [format, setFormat] = useState('csv');

  const scoped = useMemo(() => {
    let ops = [...operators];
    if (catFilter !== 'all') ops = ops.filter(o => o.category === catFilter);
    if (scope !== 'all') ops = ops.filter(o => o.id === scope);
    return ops;
  }, [operators, scope, catFilter]);

  const rows = useMemo(() => {
    const out = [];
    scoped.forEach(op => {
      op.stocks.forEach(s => {
        const activeMap = op.macroMap.filter(m => {
          const key = `${op.id}__${m.macroId}`;
          return opToggles[key] !== false;
        });
        const eng = runEngine(s, activeMap, masterMacros);
        const pt = getConvictionPT(s, eng);
        out.push({
          ticker: s.ticker, name: s.name, side: s.verdict,
          operator: op.name, category: op.category, team: op.team,
          current_price: s.currentPrice,
          bull_pt: pt.bullPT, bear_pt: pt.bearPT, conviction: pt.conviction,
          ev: eng?.ev, rr_pct: eng?.rr, skew: eng?.skew,
          engine_verdict: eng?.vd, tier: eng?.tier,
        });
      });
    });
    return out;
  }, [scoped, masterMacros, opToggles]);

  const doExport = () => {
    const ts = new Date().toISOString().slice(0,10);
    if (format === 'csv') {
      const headers = ['ticker','name','side','operator','category','team','current_price','bull_pt','bear_pt','conviction','ev','rr_pct','skew','engine_verdict','tier'];
      const csv = [headers.join(','), ...rows.map(r => headers.map(h => {
        const v = r[h];
        if (v === null || v === undefined) return '';
        if (typeof v === 'number') return v.toFixed(2);
        return `"${String(v).replace(/"/g,'""')}"`;
      }).join(','))].join('\n');
      download(csv, `xa_export_${ts}.csv`);
    } else {
      download(JSON.stringify({version:'4.0', exported:new Date().toISOString(), scope, category:catFilter, stocks:rows}, null, 2), `xa_export_${ts}.json`, 'application/json');
    }
  };

  const categories = ['GRS','Asian GRS'];
  const longs = rows.filter(r => r.side === 'long');
  const shorts = rows.filter(r => r.side === 'short');
  const strongConv = rows.filter(r => r.conviction === 'STRONG').length;
  const modConv = rows.filter(r => r.conviction === 'MODERATE').length;

  return <div style={{padding:32,maxWidth:1100,margin:'0 auto',animation:'fadeIn .3s ease'}}>
    <div style={{marginBottom:24}}>
      <h1 style={{fontSize:28,fontFamily:'var(--serif)',color:'var(--g)',fontWeight:400,marginBottom:6}}>Export Centre</h1>
      <p style={{fontSize:12,color:'var(--fg4)'}}>Conviction-based price targets ¬∑ CSV / JSON ¬∑ Scoped by category, operator, or all.</p>
    </div>

    <div style={{display:'flex',gap:6,marginBottom:16,flexWrap:'wrap',alignItems:'center'}}>
      <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',marginRight:4}}>CATEGORY:</span>
      <Btn active={catFilter==='all'} color="var(--fg3)" onClick={() => {setCatFilter('all');setScope('all')}}>All</Btn>
      {categories.map(c => <Btn key={c} active={catFilter===c} color="var(--b)" onClick={() => {setCatFilter(c);setScope('all')}}>{c}</Btn>)}

      <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',marginLeft:12,marginRight:4}}>OPERATOR:</span>
      <Btn active={scope==='all'} color="var(--fg3)" onClick={() => setScope('all')}>All</Btn>
      {operators.filter(o => catFilter==='all' || o.category===catFilter).map(o =>
        <Btn key={o.id} active={scope===o.id} color={o.color} onClick={() => setScope(o.id)}>{o.icon} {o.name}</Btn>)}

      <span style={{fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',marginLeft:12,marginRight:4}}>FORMAT:</span>
      <Btn active={format==='csv'} color="var(--y)" onClick={() => setFormat('csv')}>CSV</Btn>
      <Btn active={format==='json'} color="var(--p)" onClick={() => setFormat('json')}>JSON</Btn>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'repeat(6,1fr)',gap:10,marginBottom:20}}>
      {[
        ['Total', rows.length, 'var(--fg)'],
        ['Longs', longs.length, 'var(--g)'],
        ['Shorts', shorts.length, 'var(--r)'],
        ['Strong Conv', strongConv, 'var(--y)'],
        ['Moderate Conv', modConv, 'var(--b)'],
        ['Operators', scoped.length, 'var(--p)'],
      ].map(([l,v,c]) => <div key={l} style={{padding:'12px 14px',background:'var(--bg2)',border:'1px solid var(--border)',borderRadius:6}}>
        <div style={{fontSize:8,color:'var(--fg4)',fontFamily:'var(--mono)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:4}}>{l}</div>
        <div style={{fontSize:18,fontFamily:'var(--mono)',fontWeight:700,color:c}}>{v}</div>
      </div>)}
    </div>

    <button onClick={doExport} style={{padding:'12px 28px',borderRadius:6,fontSize:13,fontFamily:'var(--mono)',fontWeight:700,cursor:'pointer',border:'none',background:'var(--g)',color:'#000',marginBottom:24,transition:'opacity .15s'}}
      onMouseEnter={e=>e.target.style.opacity=0.85} onMouseLeave={e=>e.target.style.opacity=1}>
      ‚Üì Export {rows.length} Stocks as {format.toUpperCase()}
    </button>

    <div style={{background:'var(--bg1)',borderRadius:8,border:'1px solid var(--border)',padding:16,marginBottom:20}}>
      <div style={{fontSize:10,fontFamily:'var(--mono)',fontWeight:700,color:'var(--fg3)',marginBottom:10,textTransform:'uppercase',letterSpacing:'.1em'}}>Conviction ‚Üí Price Target Logic</div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
        {[
          ['STRONG', 'Deep Bull / Deep Bear', 'Scenarios 0 & 6', 'var(--y)'],
          ['MODERATE', 'Bull / Bear', 'Scenarios 1 & 5', 'var(--b)'],
          ['MILD', 'Mild Bull / Mild Bear', 'Scenarios 2 & 4', 'var(--fg3)'],
          ['NEUTRAL', 'Base / Base', 'Scenario 3', 'var(--fg4)'],
        ].map(([conv,tgt,scn,c]) => <div key={conv} style={{background:'var(--bg)',borderRadius:6,padding:'10px 12px',border:'1px solid var(--border)'}}>
          <div style={{fontSize:11,fontFamily:'var(--mono)',fontWeight:700,color:c,marginBottom:2}}>{conv}</div>
          <div style={{fontSize:10,fontFamily:'var(--mono)',color:'var(--fg3)'}}>{tgt}</div>
          <div style={{fontSize:8,fontFamily:'var(--mono)',color:'var(--fg4)',marginTop:2}}>{scn}</div>
        </div>)}
      </div>
    </div>

    {rows.length > 0 && <div style={{overflowX:'auto',borderRadius:6,border:'1px solid var(--border)'}}>
      <table style={{width:'100%',borderCollapse:'collapse',fontSize:10,fontFamily:'var(--mono)'}}>
        <thead><tr style={{background:'var(--bg2)'}}>
          {['Ticker','Name','Side','Operator','Cat','Price','Bull PT','Bear PT','Conv','EV','R/R','Skew','Verdict','Tier'].map(h =>
            <th key={h} style={{padding:'8px 8px',textAlign:'left',color:'var(--fg3)',fontSize:8,textTransform:'uppercase',letterSpacing:'.05em',borderBottom:'1px solid var(--border)',whiteSpace:'nowrap'}}>{h}</th>)}
        </tr></thead>
        <tbody>{rows.slice(0,100).map((r,i) => {
          const isLong = r.side === 'long';
          const vc = r.engine_verdict?.includes('LONG')?'var(--g)':r.engine_verdict?.includes('SHORT')?'var(--r)':'var(--fg4)';
          const cc = r.conviction==='STRONG'?'var(--y)':r.conviction==='MODERATE'?'var(--b)':'var(--fg4)';
          return <tr key={i} style={{borderBottom:'1px solid var(--border)'}}>
            <td style={{padding:'6px 8px',color:isLong?'var(--g)':'var(--r)',fontWeight:700}}>{r.ticker}</td>
            <td style={{padding:'6px 8px',color:'var(--fg3)'}}>{r.name}</td>
            <td style={{padding:'6px 8px',color:isLong?'var(--g)':'var(--r)',fontWeight:600}}>{r.side}</td>
            <td style={{padding:'6px 8px',color:'var(--fg4)'}}>{r.operator}</td>
            <td style={{padding:'6px 8px',color:'var(--fg4)'}}>{r.category}</td>
            <td style={{padding:'6px 8px',color:'var(--fg)'}}>{fmt(r.current_price,'price')}</td>
            <td style={{padding:'6px 8px',color:'var(--g)',fontWeight:600}}>{fmt(r.bull_pt,'price')}</td>
            <td style={{padding:'6px 8px',color:'var(--r)',fontWeight:600}}>{fmt(r.bear_pt,'price')}</td>
            <td style={{padding:'6px 8px',color:cc,fontWeight:600}}>{r.conviction}</td>
            <td style={{padding:'6px 8px',color:'#6366f1'}}>{fmt(r.ev,'price')}</td>
            <td style={{padding:'6px 8px',color:r.rr_pct>0?'var(--g)':'var(--r)',fontWeight:600}}>{fmt(r.rr_pct,'pct')}</td>
            <td style={{padding:'6px 8px',color:r.skew>1?'#22d3ee':'#f97316'}}>{r.skew?.toFixed(2)}</td>
            <td style={{padding:'6px 8px',color:vc,fontWeight:700}}>{r.engine_verdict}</td>
            <td style={{padding:'6px 8px',color:r.tier==='Core'?'var(--y)':r.tier==='Satellite'?'var(--b)':'var(--fg4)'}}>{r.tier}</td>
          </tr>;
        })}</tbody>
      </table>
      {rows.length > 100 && <div style={{padding:'8px 16px',fontSize:9,fontFamily:'var(--mono)',color:'var(--fg4)',textAlign:'center'}}>Showing 100 of {rows.length} ‚Äî export for full dataset</div>}
    </div>}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP SHELL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App() {
  const [view, setView] = useState('overview');
  const [masterMacros, setMasterMacros] = useState(() => {
    const saved = LS.get('xa_master_macros_v4');
    return saved || MASTER_MACROS_DEFAULT.map(m => ({...m}));
  });
  const [opToggles, setOpToggles] = useState(() => LS.get('xa_op_toggles_v4') || {});
  const [snapData, setSnapData] = useState(() => LS.get('xa_snap_v3'));

  useEffect(() => { LS.set('xa_master_macros_v4', masterMacros); }, [masterMacros]);
  useEffect(() => { LS.set('xa_op_toggles_v4', opToggles); }, [opToggles]);

  const operators = OPERATORS;

  return <div style={{height:'100vh',display:'flex',flexDirection:'column',overflow:'hidden'}}>
    <Header view={view} setView={setView} />
    <div style={{flex:1,overflowY:'auto'}}>
      {view === 'overview' && <OverviewView operators={operators} masterMacros={masterMacros} setView={setView} />}
      {view === 'macro' && <MacroView operators={operators} masterMacros={masterMacros} setMasterMacros={setMasterMacros} opToggles={opToggles} setOpToggles={setOpToggles} />}
      {view === 'operators' && <OperatorsView operators={operators} masterMacros={masterMacros} />}
      {view === 'data' && <DataView operators={operators} masterMacros={masterMacros} snapData={snapData} setSnapData={setSnapData} />}
      {view === 'export' && <ExportView operators={operators} masterMacros={masterMacros} opToggles={opToggles} />}
    </div>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
